<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JARVIS 2.1 ‚Äî Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a2e;--bg4:#252540;--accent:#00d4ff;--accent2:#7c3aed;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--yellow:#eab308;--pink:#ec4899;--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--radius:12px;--shadow:0 4px 24px rgba(0,0,0,0.4)}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
.app{display:flex;height:100vh}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--bg3);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--bg3);display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo{padding:16px;text-align:center;border-bottom:1px solid var(--bg3)}
.logo h1{font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo small{color:var(--text3);font-size:10px}
.player-card{padding:12px;border-bottom:1px solid var(--bg3)}
.player-level{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.player-level .lvl{font-size:16px;font-weight:700;color:var(--accent)}
.player-level .rank{font-size:11px;color:var(--text2)}
.xp-bar{height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;margin-bottom:4px}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .5s}
.xp-text{font-size:10px;color:var(--text3);display:flex;justify-content:space-between}
.streak-row{display:flex;align-items:center;gap:4px;margin-top:6px;font-size:12px}
.nav-section{padding:10px}
.nav-section h3{font-size:10px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;letter-spacing:1px}
.nav-btn{width:100%;padding:8px 10px;background:none;border:none;color:var(--text2);cursor:pointer;text-align:left;border-radius:8px;font-size:12px;display:flex;align-items:center;gap:6px;transition:all .2s;margin-bottom:1px}
.nav-btn:hover{background:var(--bg3);color:var(--text)}.nav-btn.active{background:var(--bg3);color:var(--accent)}
.nav-btn .badge{margin-left:auto;background:var(--red);color:white;font-size:9px;padding:1px 5px;border-radius:8px;font-weight:700}
.project-item{padding:8px 10px;cursor:pointer;border-radius:8px;margin-bottom:1px;display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);transition:all .2s}
.project-item:hover{background:var(--bg3);color:var(--text)}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;display:inline-block}
.dot-idea{background:var(--text3)}.dot-validation{background:var(--orange)}.dot-mvp{background:var(--accent)}.dot-launch{background:var(--green)}.dot-growth{background:var(--pink)}
.content{flex:1;overflow-y:auto;padding:16px}
.card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card h2{font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.stat-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:14px;text-align:center}
.stat-card .num{font-size:24px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-card .label{font-size:10px;color:var(--text3);margin-top:2px;text-transform:uppercase}
.funnel{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.funnel-stage{flex:1;min-width:100px;background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:10px;text-align:center;cursor:pointer;transition:all .2s}
.funnel-stage:hover{border-color:var(--accent)}
.funnel-stage .stage-icon{font-size:20px}.funnel-stage .stage-name{font-size:10px;color:var(--text2);margin-top:2px}
.funnel-stage .stage-count{font-size:18px;font-weight:700;color:var(--accent);margin-top:2px}
.funnel-arrow{display:flex;align-items:center;color:var(--text3);font-size:16px}
.chat-container{display:flex;flex-direction:column;height:100%}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
.chat-input-row{padding:12px 16px;background:var(--bg2);border-top:1px solid var(--bg3);display:flex;gap:6px}
.chat-input-row input{flex:1;padding:10px 14px;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--text);font-size:13px;outline:none}
.chat-input-row input:focus{border-color:var(--accent)}
.msg{max-width:80%;padding:10px 14px;border-radius:var(--radius);font-size:13px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
.msg.user{background:var(--accent2);align-self:flex-end;border-bottom-right-radius:4px}
.msg.bot{background:var(--bg3);align-self:flex-start;border-bottom-left-radius:4px}
.msg .time{font-size:9px;color:var(--text3);margin-top:3px}
.btn{padding:8px 14px;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:4px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--bg4)}
.btn-secondary:hover{border-color:var(--accent)}
.btn-danger{background:var(--red);color:white}.btn-success{background:var(--green);color:white}
.btn-sm{padding:5px 10px;font-size:11px}.btn-icon{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center}
.form-group{margin-bottom:10px}
.form-group label{display:block;font-size:11px;color:var(--text2);margin-bottom:3px}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:8px 10px;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--text);font-size:13px;outline:none;font-family:inherit}
.form-group input:focus,.form-group textarea:focus{border-color:var(--accent)}
.form-group textarea{resize:vertical;min-height:60px}
.mode-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px}
.mode-btn{padding:10px;background:var(--bg3);border:2px solid transparent;border-radius:var(--radius);cursor:pointer;text-align:center;transition:all .2s}
.mode-btn:hover{border-color:var(--accent)}.mode-btn.active{border-color:var(--accent);background:rgba(0,212,255,0.1)}
.mode-btn .mode-emoji{font-size:20px;display:block;margin-bottom:2px}.mode-btn .mode-name{font-size:10px;color:var(--text2)}
.quest-item{background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:6px}
.quest-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.quest-name{font-size:13px;font-weight:600}.quest-xp{font-size:11px;color:var(--accent)}
.quest-priority{font-size:9px;padding:2px 6px;border-radius:8px}
.priority-urgent{background:rgba(239,68,68,0.2);color:var(--red)}.priority-normal{background:rgba(16,185,129,0.2);color:var(--green)}
.quest-task{display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;font-size:12px}
.quest-task input[type=checkbox]{accent-color:var(--accent);width:14px;height:14px;cursor:pointer}
.quest-task.done{text-decoration:line-through;color:var(--text3)}.quest-completed{opacity:0.5}
.mission-card{background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(124,58,237,0.1));border:1px solid var(--accent)}
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px}
.ach-item{text-align:center;padding:10px 6px;background:var(--bg3);border-radius:var(--radius);transition:all .2s}
.ach-item.locked{opacity:0.3;filter:grayscale(1)}.ach-item .ach-icon{font-size:24px;display:block;margin-bottom:2px}.ach-item .ach-name{font-size:9px;color:var(--text2)}
.chart-container{position:relative;height:200px;margin-bottom:12px}
.toast-container{position:fixed;top:16px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:6px}
.toast{padding:12px 16px;border-radius:var(--radius);color:white;font-size:12px;font-weight:600;animation:slideIn .3s ease,fadeOut .3s ease 3s forwards;box-shadow:var(--shadow);max-width:300px}
.toast-success{background:var(--green)}.toast-error{background:var(--red)}.toast-info{background:var(--accent);color:var(--bg)}
.toast-achievement{background:linear-gradient(135deg,var(--orange),var(--pink))}.toast-levelup{background:linear-gradient(135deg,var(--accent),var(--accent2))}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeOut{to{opacity:0;transform:translateY(-20px)}}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:center;justify-content:center}
.modal{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal h2{margin-bottom:12px;font-size:16px}.modal-actions{display:flex;gap:6px;margin-top:12px;justify-content:flex-end}
.tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;background:var(--bg4);color:var(--text2);margin:2px}
.tag.active{background:var(--accent);color:var(--bg)}
.pain-item{background:var(--bg3);border-radius:8px;padding:10px;margin-bottom:6px;font-size:12px}
.pain-item .pain-source{font-size:10px;color:var(--text3)}
.pain-status{font-size:9px;padding:2px 6px;border-radius:8px}
.status-new{background:rgba(0,212,255,0.2);color:var(--accent)}
.status-validated{background:rgba(16,185,129,0.2);color:var(--green)}
.status-rejected{background:rgba(239,68,68,0.2);color:var(--red)}
.sprint-item{background:var(--bg3);border-radius:var(--radius);padding:12px;margin-bottom:8px}
.sprint-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.sprint-progress{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-bottom:6px}
.sprint-progress-fill{height:100%;background:var(--green);border-radius:2px;transition:width .3s}
.daily-challenge{background:var(--bg3);border-radius:8px;padding:10px;margin-bottom:6px;display:flex;align-items:center;gap:8px;cursor:pointer}
.daily-challenge.done{opacity:0.5;text-decoration:line-through}
.daily-challenge .dc-xp{margin-left:auto;color:var(--accent);font-size:11px;font-weight:700}
.stuck-alert{background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:var(--radius);padding:12px;margin-bottom:8px}
.stuck-alert .stuck-title{color:var(--red);font-weight:700;font-size:13px}
.stuck-alert .stuck-text{color:var(--text2);font-size:12px;margin-top:4px}
.stage-step{flex:1;padding:6px;text-align:center;border-radius:8px;font-size:10px;cursor:pointer;transition:all .2s;background:var(--bg4);color:var(--text3)}
.stage-step.current{background:var(--accent);color:var(--bg);font-weight:700}
.stage-step.passed{background:rgba(16,185,129,0.3);color:var(--green)}
.stage-step:hover{opacity:.8}
.link-item{display:flex;align-items:center;gap:6px;padding:6px;background:var(--bg3);border-radius:8px;margin-bottom:4px;font-size:12px}
.link-item a{color:var(--accent);text-decoration:none;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.link-item a:hover{text-decoration:underline}
.note-item{padding:8px;background:var(--bg3);border-radius:8px;margin-bottom:4px;font-size:12px}
.note-item .note-date{font-size:9px;color:var(--text3);margin-top:2px}
.reddit-post{background:var(--bg3);border-radius:8px;padding:10px;margin-bottom:6px}
.reddit-post .post-title{font-size:12px;font-weight:600;color:var(--accent)}
.reddit-post .post-meta{font-size:10px;color:var(--text3);margin-top:2px}
.reddit-post .post-text{font-size:11px;color:var(--text2);margin-top:4px}
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:22px;cursor:pointer}
.section-title{font-size:13px;font-weight:700;color:var(--text2);margin:16px 0 8px;display:flex;align-items:center;gap:6px}
@media(max-width:768px){
.sidebar{position:fixed;left:-260px;top:0;bottom:0;z-index:8000;transition:left .3s}.sidebar.open{left:0}
.hamburger{display:block}.stats-grid{grid-template-columns:repeat(2,1fr)}.funnel{flex-direction:column}
.funnel-arrow{display:none}.mode-grid{grid-template-columns:repeat(3,1fr)}.ach-grid{grid-template-columns:repeat(4,1fr)}
.msg{max-width:95%}.chart-container{height:160px}.modal{width:95%}
}
</style>
</head>
<body>
<div class="toast-container" id="toasts"></div>
<div class="app">
<aside class="sidebar" id="sidebar">
<div class="logo"><h1>ü§ñ JARVIS 2.1</h1><small>AI Command Center</small></div>
<div class="player-card" id="playerCard"></div>
<div class="nav-section">
<h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
<button class="nav-btn active" onclick="go('dashboard')">üìä Dashboard</button>
<button class="nav-btn" onclick="go('today')">üìÖ –°–µ–≥–æ–¥–Ω—è</button>
<button class="nav-btn" onclick="go('chat')">üí¨ AI –ß–∞—Ç</button>
<button class="nav-btn" onclick="go('projects')">üöÄ –ü—Ä–æ–µ–∫—Ç—ã</button>
<button class="nav-btn" onclick="go('quests')">‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</button>
<button class="nav-btn" onclick="go('sprints')">üèÉ –°–ø—Ä–∏–Ω—Ç—ã</button>
<button class="nav-btn" onclick="go('research')">üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</button>
<button class="nav-btn" onclick="go('pains')">üéØ –ë–∞–∑–∞ –±–æ–ª–µ–π</button>
<button class="nav-btn" onclick="go('funnel')">üìà –í–æ—Ä–æ–Ω–∫–∞</button>
<button class="nav-btn" onclick="go('achievements')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
<button class="nav-btn" onclick="go('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>
<div class="nav-section"><h3>–ü—Ä–æ–µ–∫—Ç—ã</h3><div id="sidebarProjects"></div></div>
</aside>
<div class="main">
<div class="topbar">
<button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
<span id="pageTitle" style="font-weight:700;font-size:14px">üìä Dashboard</span>
<div style="margin-left:auto"><button class="btn btn-sm btn-secondary" onclick="loadAll()">üîÑ</button></div>
</div>
<div class="content" id="content"></div>
</div>
</div>
<script>
const SID=localStorage.getItem('j_sid')||((s='s_'+Math.random().toString(36).slice(2))&&(localStorage.setItem('j_sid',s),s));
let S={player:{},stats:{},projects:[],quests:[],achievements:[],mission:{},history:[],modes:{},daily:{},dailyPlan:{},pains:[],sprints:[],tags:[],page:'dashboard',proj:null,chat:JSON.parse(localStorage.getItem('j_chat')||'[]'),mode:'helper'};

function toast(t,y='info'){const c=document.getElementById('toasts'),d=document.createElement('div');d.className='toast toast-'+y;d.textContent=t;c.appendChild(d);setTimeout(()=>d.remove(),3500)}
async function api(u,m='GET',b=null){try{const o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);const r=await fetch(u,o);return await r.json()}catch(e){return null}}

async function loadAll(){
const[st,pr,qu,ac,mi,hi,mo,da,dp,pa,sp,tg]=await Promise.all([
api('/api/stats'),api('/api/projects'),api('/api/quests'),api('/api/achievements'),
api('/api/mission'),api('/api/history'),api('/api/modes'),api('/api/daily'),
api('/api/daily-plan'),api('/api/pains'),api('/api/sprints'),api('/api/tags')]);
if(st){S.stats=st;if(st.player)S.player=st.player}
if(pr?.projects)S.projects=pr.projects;if(qu?.quests)S.quests=qu.quests;
if(ac)S.achievements=ac;if(mi)S.mission=mi;if(hi?.entries)S.history=hi.entries;
if(mo)S.modes=mo;if(da)S.daily=da;if(dp)S.dailyPlan=dp;
if(pa?.pains)S.pains=pa.pains;if(sp?.sprints)S.sprints=sp.sprints;
if(tg?.tags)S.tags=tg.tags;
updPlayer();updSidebar();render()}

function updPlayer(){const p=S.player;if(!p.level)return;const pct=p.xp_to_next>0?(p.xp/p.xp_to_next*100):0;
document.getElementById('playerCard').innerHTML=`<div class="player-level"><span class="lvl">Lv.${p.level}</span><span class="rank">${p.rank||'–ù–æ–≤–∏—á–æ–∫'}</span></div><div class="xp-bar"><div class="xp-bar-fill" style="width:${pct}%"></div></div><div class="xp-text"><span>${p.xp||0} XP</span><span>/ ${p.xp_to_next||1000}</span></div><div class="streak-row">üî• ${p.streak||0}–¥ ${p.max_streak?'(—Ä–µ–∫:'+p.max_streak+')':''}</div>`}

function updSidebar(){const c=document.getElementById('sidebarProjects');
const a=S.projects.filter(p=>p.status!=='archived');
c.innerHTML=a.map(p=>`<div class="project-item" onclick="openProj('${p.id}')"><span class="dot dot-${p.stage||'idea'}"></span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name}</span>${p.revenue>0?`<span style="color:var(--green);font-size:10px">$${p.revenue}</span>`:''}</div>`).join('')||'<div style="padding:10px;color:var(--text3);font-size:11px">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>'}

function go(p){S.page=p;S.proj=null;document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
const t={dashboard:'üìä Dashboard',today:'üìÖ –°–µ–≥–æ–¥–Ω—è',chat:'üí¨ AI –ß–∞—Ç',projects:'üöÄ –ü—Ä–æ–µ–∫—Ç—ã',quests:'‚öîÔ∏è –ö–≤–µ—Å—Ç—ã',sprints:'üèÉ –°–ø—Ä–∏–Ω—Ç—ã',research:'üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è',pains:'üéØ –ë–∞–∑–∞ –±–æ–ª–µ–π',funnel:'üìà –í–æ—Ä–æ–Ω–∫–∞',achievements:'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',settings:'‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'};
document.getElementById('pageTitle').textContent=t[p]||p;document.getElementById('sidebar').classList.remove('open');render()}

function render(){const c=document.getElementById('content');const fn={dashboard:rDash,today:rToday,chat:rChat,projects:rProjects,quests:rQuests,sprints:rSprints,research:rResearch,pains:rPains,funnel:rFunnel,achievements:rAch,settings:rSettings,projDetail:rProjDetail};
c.innerHTML=(fn[S.page]||rDash)();afterRender()}

function afterRender(){if(S.page==='chat'){const m=document.getElementById('chatMsgs');if(m)m.scrollTop=m.scrollHeight;document.getElementById('chatIn')?.focus()}
if(S.page==='dashboard')initCharts()}

// === DASHBOARD ===
function rDash(){const s=S.stats,p=S.player,m=S.mission,f=s.funnel||{},stuck=s.stuck_projects||[];
return `${stuck.length?stuck.map(x=>`<div class="stuck-alert"><div class="stuck-title">‚ö†Ô∏è ${x.name} –∑–∞—Å—Ç—Ä—è–ª!</div><div class="stuck-text">${x.days} –¥–Ω–µ–π –Ω–∞ —Å—Ç–∞–¥–∏–∏ ${x.stage} (–ª–∏–º–∏—Ç ${x.deadline}–¥) <button class="btn btn-sm btn-primary" onclick="openProj('${x.id}')" style="margin-left:8px">–û—Ç–∫—Ä—ã—Ç—å</button></div></div>`).join(''):''}
<div class="stats-grid">
<div class="stat-card"><div class="num">${s.active_projects||0}</div><div class="label">–ü—Ä–æ–µ–∫—Ç—ã</div></div>
<div class="stat-card"><div class="num">$${s.total_revenue||0}</div><div class="label">–î–æ—Ö–æ–¥</div></div>
<div class="stat-card"><div class="num">${s.completed_quests||0}</div><div class="label">–ö–≤–µ—Å—Ç—ã</div></div>
<div class="stat-card"><div class="num">${p.total_xp||0}</div><div class="label">XP</div></div>
<div class="stat-card"><div class="num">${s.total_messages||0}</div><div class="label">–°–æ–æ–±—â–µ–Ω–∏—è</div></div>
<div class="stat-card"><div class="num">${s.saved_pains||0}</div><div class="label">–ë–æ–ª–∏</div></div>
</div>
${m.name&&!m.completed?`<div class="card mission-card"><h2>üéØ ${m.name}</h2>${(m.tasks||[]).map((t,i)=>`<div class="quest-task ${t.done?'done':''}" onclick="togMission(${i})"><input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();togMission(${i})"><span>${t.text}</span></div>`).join('')}<div style="font-size:11px;color:var(--accent);margin-top:6px">‚è∞ –î–æ ${m.week_end||'...'} | +${m.xp_reward||500} XP</div></div>`:''}
<div class="card"><h2>üìà –í–æ—Ä–æ–Ω–∫–∞</h2><div class="funnel">${Object.entries(f).map(([k,v])=>`<div class="funnel-stage" onclick="go('funnel')"><div class="stage-icon">${{idea:'üí°',validation:'üîç',mvp:'üõ†',launch:'üöÄ',growth:'üìà'}[k]||'üì¶'}</div><div class="stage-name">${v.name||k}</div><div class="stage-count">${v.count||0}</div></div>${k!=='growth'?'<div class="funnel-arrow">‚Üí</div>':''}`).join('')}</div></div>
<div class="card"><h2>üìä XP</h2><div class="chart-container"><canvas id="chXP"></canvas></div></div>
<div class="card"><h2>üí∞ –î–æ—Ö–æ–¥</h2><div class="chart-container"><canvas id="chRev"></canvas></div></div>`}

function initCharts(){const e=S.history||[];if(e.length<1)return;const l=e.map(x=>x.date?.slice(5)||'');
const xE=document.getElementById('chXP'),rE=document.getElementById('chRev');
if(xE)new Chart(xE,{type:'line',data:{labels:l,datasets:[{label:'XP',data:e.map(x=>x.xp||0),borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,0.1)',fill:true,tension:.3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b'}}}}});
if(rE)new Chart(rE,{type:'bar',data:{labels:l,datasets:[{label:'$',data:e.map(x=>x.revenue||0),backgroundColor:'rgba(16,185,129,0.6)',borderColor:'#10b981',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b'}}}}})}

// === TODAY ===
function rToday(){const dp=S.dailyPlan,d=S.daily;
return `<div class="card"><h2>üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏</h2>${(d.challenges||[]).map((c,i)=>`<div class="daily-challenge ${c.done?'done':''}" onclick="compDaily(${i})"><input type="checkbox" ${c.done?'checked':''} onclick="event.stopPropagation();compDaily(${i})"><span>${c.text}</span><span class="dc-xp">+${c.xp} XP</span></div>`).join('')}${d.completed?'<div style="color:var(--green);font-size:12px;margin-top:8px">‚úÖ –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +100 XP –±–æ–Ω—É—Å</div>':''}</div>
${(dp.sections||[]).map(sec=>`<div class="card"><h2>${sec.title}</h2>${(sec.items||[]).map(it=>`<div style="padding:4px 0;font-size:12px;color:var(--text2)">${it}</div>`).join('')}</div>`).join('')}`}

async function compDaily(i){const r=await api('/api/daily/complete','POST',{index:i});if(r?.xp_earned)toast('+'+r.xp_earned+' XP!','success');await loadAll()}

// === CHAT ===
function rChat(){const mk=Object.keys(S.modes);
return `<div class="mode-grid" style="margin-bottom:12px">${mk.map(k=>{const m=S.modes[k];return`<div class="mode-btn ${S.mode===k?'active':''}" onclick="setMode('${k}')"><span class="mode-emoji">${m.emoji}</span><span class="mode-name">${m.name}</span></div>`}).join('')}</div>
<div class="chat-container" style="height:calc(100vh - 250px)"><div class="chat-messages" id="chatMsgs">${S.chat.map(m=>`<div class="msg ${m.role}">${m.text}<div class="time">${m.time||''}</div></div>`).join('')}</div>
<div class="chat-input-row"><input id="chatIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendChat()"><button class="btn btn-primary" onclick="sendChat()">‚û§</button><button class="btn btn-secondary btn-icon" onclick="clrChat()">üóë</button></div></div>`}

async function setMode(m){S.mode=m;await api('/api/mode','POST',{session_id:SID,mode:m});toast(S.modes[m]?.name||m,'info');render()}
async function sendChat(){const inp=document.getElementById('chatIn'),t=inp.value.trim();if(!t)return;inp.value='';const tm=new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
S.chat.push({role:'user',text:t,time:tm});render();const r=await api('/api/send','POST',{session_id:SID,text:t});
if(r?.answer){S.chat.push({role:'bot',text:r.answer,time:r.time||tm});localStorage.setItem('j_chat',JSON.stringify(S.chat.slice(-50)));
const st=await api('/api/stats');if(st?.player){const ol=S.player.level||1;S.player=st.player;S.stats=st;updPlayer();if(st.player.level>ol)toast('üéâ –£—Ä–æ–≤–µ–Ω—å '+st.player.level+'!','levelup')}}render()}
function clrChat(){S.chat=[];localStorage.removeItem('j_chat');api('/api/clear','POST',{session_id:SID});render()}

// === PROJECTS ===
function rProjects(){const a=S.projects.filter(p=>p.status!=='archived'),ar=S.projects.filter(p=>p.status==='archived');
return `<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap"><button class="btn btn-primary" onclick="newProj()">‚ûï –ù–æ–≤—ã–π</button>${S.tags.map(t=>`<span class="tag" style="cursor:pointer" onclick="filterTag('${t}')">${t}</span>`).join('')}</div>
${a.map(p=>`<div class="card" style="cursor:pointer" onclick="openProj('${p.id}')"><div style="display:flex;justify-content:space-between;align-items:center"><div><span class="dot dot-${p.stage||'idea'}" style="margin-right:6px"></span><strong>${p.name}</strong><span style="color:var(--text3);font-size:11px;margin-left:6px">${{idea:'üí°',validation:'üîç',mvp:'üõ†',launch:'üöÄ',growth:'üìà'}[p.stage||'idea']}</span>${p.score?`<span style="margin-left:6px;font-size:10px;color:var(--orange)">${p.score}/100</span>`:''}</div><div style="display:flex;gap:8px;align-items:center">${p.revenue>0?`<span style="color:var(--green);font-weight:700">$${p.revenue}</span>`:''}<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();archProj('${p.id}')">üì¶</button></div></div>${p.tags?.length?`<div style="margin-top:4px">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>`:''}</div>`).join('')||'<div class="card"><p style="color:var(--text3)">–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!</p></div>'}
${ar.length?`<div class="section-title">üì¶ –ê—Ä—Ö–∏–≤ (${ar.length})</div>${ar.map(p=>`<div class="card" style="opacity:0.5"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${p.name}</strong><button class="btn btn-sm btn-secondary" onclick="restProj('${p.id}')">‚ôªÔ∏è</button></div></div>`).join('')}`:''}`}

function filterTag(t){/* –ø—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è */const a=S.projects.filter(p=>p.status!=='archived'&&(p.tags||[]).includes(t));
if(a.length)toast(t+': '+a.length+' –ø—Ä–æ–µ–∫—Ç–æ–≤','info');else toast('–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å —Ç–µ–≥–æ–º '+t,'info')}

function newProj(){showModal('–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',`<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="pN" placeholder="–ü—Ä–æ–µ–∫—Ç"></div><div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="pD" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea></div><div class="form-group"><label>–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</label><input id="pM" placeholder="–ü–æ–¥–ø–∏—Å–∫–∏, —Ä–µ–∫–ª–∞–º–∞..."></div><div class="form-group"><label>–¢–µ–≥–∏</label><div id="tagSel" style="display:flex;flex-wrap:wrap;gap:4px">${S.tags.map(t=>`<span class="tag" style="cursor:pointer" onclick="this.classList.toggle('active')" data-tag="${t}">${t}</span>`).join('')}</div></div>`,async()=>{const tags=[...document.querySelectorAll('#tagSel .tag.active')].map(e=>e.dataset.tag);
const r=await api('/api/projects','POST',{name:document.getElementById('pN').value,description:document.getElementById('pD').value,monetization:document.getElementById('pM').value,tags});
if(r?.id){toast('üöÄ –°–æ–∑–¥–∞–Ω!','success');closeModal();await loadAll()}})}

async function archProj(id){await api('/api/projects/'+id,'DELETE');toast('üì¶ –ê—Ä—Ö–∏–≤','info');await loadAll()}
async function restProj(id){await api('/api/projects/'+id+'/restore','POST');toast('‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω','success');await loadAll()}

// === PROJECT DETAIL ===
function openProj(id){S.proj=id;S.page='projDetail';render()}
function rProjDetail(){const p=S.projects.find(x=>x.id===S.proj);if(!p)return'<div class="card">–ù–µ –Ω–∞–π–¥–µ–Ω</div>';
const q=S.quests.filter(x=>x.project_id===p.id),sp=S.sprints.filter(x=>x.project_id===p.id);
const stages=['idea','validation','mvp','launch','growth'],sn={idea:'üí° –ò–¥–µ—è',validation:'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è',mvp:'üõ† MVP',launch:'üöÄ –ó–∞–ø—É—Å–∫',growth:'üìà –†–æ—Å—Ç'};
const ci=stages.indexOf(p.stage||'idea');
return `<button class="btn btn-sm btn-secondary" onclick="go('projects')" style="margin-bottom:12px">‚Üê –ù–∞–∑–∞–¥</button>
<div class="card"><h2>${p.name}${p.stage_overdue?'<span style="color:var(--red);font-size:11px;margin-left:8px">‚ö†Ô∏è –ó–∞—Å—Ç—Ä—è–ª!</span>':''}</h2>
<p style="color:var(--text2);font-size:12px;margin-bottom:8px">${p.description||''}</p>
<p style="font-size:11px;color:var(--text3)">üí∞ ${p.monetization||'‚Äî'} | üíµ $${p.revenue||0}${p.days_in_stage!=null?' | üìÖ '+p.days_in_stage+'–¥ –Ω–∞ —Å—Ç–∞–¥–∏–∏':''}</p>
${p.tags?.length?`<div style="margin-top:6px">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>`:''}
<div style="display:flex;gap:4px;margin-top:12px">${stages.map((s,i)=>`<div class="stage-step ${i===ci?'current':''} ${i<ci?'passed':''}" onclick="chgStage('${p.id}','${s}')">${sn[s]}</div>`).join('')}</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px">
<button class="btn btn-sm btn-success" onclick="addRev('${p.id}')">üí∞ –î–æ—Ö–æ–¥</button>
<button class="btn btn-sm btn-secondary" onclick="addLink('${p.id}')">üîó –°—Å—ã–ª–∫–∞</button>
<button class="btn btn-sm btn-secondary" onclick="addNote('${p.id}')">üìù –ó–∞–º–µ—Ç–∫–∞</button>
<button class="btn btn-sm btn-secondary" onclick="genOffer('${p.id}')">‚ú® –û—Ñ—Ñ–µ—Ä</button>
<button class="btn btn-sm btn-secondary" onclick="genSprintForProj('${p.id}','${p.name}')">üèÉ –°–ø—Ä–∏–Ω—Ç</button>
</div></div>
${q.length?`<div class="card"><h2>‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</h2>${q.map(x=>rQuestItem(x)).join('')}</div>`:''}
${sp.length?`<div class="card"><h2>üèÉ –°–ø—Ä–∏–Ω—Ç—ã</h2>${sp.map(x=>rSprintItem(x)).join('')}</div>`:''}
${(p.links||[]).length?`<div class="card"><h2>üîó –°—Å—ã–ª–∫–∏</h2>${p.links.map(l=>`<div class="link-item"><a href="${l.url}" target="_blank">${l.title||l.url}</a><button class="btn btn-sm btn-danger btn-icon" onclick="delLink('${p.id}','${l.id}')">‚úï</button></div>`).join('')}</div>`:''}
${(p.notes||[]).length?`<div class="card"><h2>üìù –ó–∞–º–µ—Ç–∫–∏</h2>${p.notes.map(n=>`<div class="note-item">${n.text}<div class="note-date">${n.added?.slice(0,10)||''}</div></div>`).join('')}</div>`:''}
${(p.revenue_history||[]).length?`<div class="card"><h2>üíµ –î–æ—Ö–æ–¥—ã</h2>${p.revenue_history.map(r=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bg3);font-size:12px"><span style="color:var(--green)">+$${r.amount}</span><span style="color:var(--text3)">${r.note||''} ${r.date?.slice(0,10)||''}</span></div>`).join('')}</div>`:''}`}

async function chgStage(pid,s){const r=await api('/api/projects/'+pid+'/stage','PUT',{stage:s});if(r?.stage){toast('–°—Ç–∞–¥–∏—è: '+ s,'success');await loadAll();openProj(pid)}}
function addRev(pid){showModal('–î–æ—Ö–æ–¥',`<div class="form-group"><label>–°—É–º–º–∞ $</label><input id="rA" type="number" placeholder="100"></div><div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><input id="rN" placeholder="–û—Ç–∫—É–¥–∞?"></div>`,async()=>{await api('/api/projects/'+pid+'/revenue','POST',{amount:parseFloat(document.getElementById('rA').value)||0,note:document.getElementById('rN').value});toast('üí∞!','success');closeModal();await loadAll();openProj(pid)})}
function addLink(pid){showModal('–°—Å—ã–ª–∫–∞',`<div class="form-group"><label>URL</label><input id="lU" placeholder="https://..."></div><div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="lT" placeholder="–°–∞–π—Ç"></div>`,async()=>{await api('/api/projects/'+pid+'/links','POST',{url:document.getElementById('lU').value,title:document.getElementById('lT').value});toast('üîó!','success');closeModal();await loadAll();openProj(pid)})}
function addNote(pid){showModal('–ó–∞–º–µ—Ç–∫–∞',`<div class="form-group"><label>–¢–µ–∫—Å—Ç</label><textarea id="nT" placeholder="..."></textarea></div>`,async()=>{await api('/api/projects/'+pid+'/notes','POST',{text:document.getElementById('nT').value});toast('üìù!','success');closeModal();await loadAll();openProj(pid)})}
async function delLink(pid,lid){await api('/api/projects/'+pid+'/links/'+lid,'DELETE');await loadAll();openProj(pid)}
async function genOffer(pid){toast('‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é...','info');const r=await api('/api/projects/'+pid+'/offer','POST');if(r?.offer)showModal('‚ú® –û—Ñ—Ñ–µ—Ä',`<div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.offer}</div>`,null)}
async function genSprintForProj(pid,pname){toast('üèÉ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–ø—Ä–∏–Ω—Ç...','info');const r=await api('/api/generate-sprints','POST',{project:pname,weeks:1});
if(r?.sprints){showModal('üèÉ –°–ø—Ä–∏–Ω—Ç',`<div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.sprints}</div><div class="form-group" style="margin-top:12px"><label>–ó–∞–¥–∞—á–∏ (–ø–æ —Å—Ç—Ä–æ–∫–µ)</label><textarea id="spTasks" placeholder="–ó–∞–¥–∞—á–∞ 1\n–ó–∞–¥–∞—á–∞ 2\n–ó–∞–¥–∞—á–∞ 3"></textarea></div>`,async()=>{const tasks=document.getElementById('spTasks').value.split('\n').filter(t=>t.trim());
if(tasks.length){await api('/api/sprints','POST',{project_id:pid,name:'–°–ø—Ä–∏–Ω—Ç',tasks,duration:7});toast('üèÉ –°–æ–∑–¥–∞–Ω!','success');closeModal();await loadAll();openProj(pid)}})}}

// === QUESTS ===
function rQuests(){const a=S.quests.filter(q=>!q.completed),d=S.quests.filter(q=>q.completed);
return `<button class="btn btn-primary" onclick="newQuest()" style="margin-bottom:12px">‚ûï –ö–≤–µ—Å—Ç</button>
${a.length?`<div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ (${a.length})</div>`:''}${a.map(q=>rQuestItem(q)).join('')}
${!a.length?'<div class="card"><p style="color:var(--text3)">–í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ</p></div>':''}
${d.length?`<div class="section-title" style="color:var(--text3)">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (${d.length})</div>${d.slice(-5).map(q=>rQuestItem(q)).join('')}`:''}`}

function rQuestItem(q){const pn=S.projects.find(p=>p.id===q.project_id)?.name||'';
return `<div class="quest-item ${q.completed?'quest-completed':''}"><div class="quest-header"><div><span class="quest-name">${q.name}</span>${pn?`<span style="font-size:10px;color:var(--text3);margin-left:6px">üìÇ ${pn}</span>`:''}</div><div style="display:flex;gap:6px;align-items:center"><span class="quest-priority priority-${q.priority||'normal'}">${q.priority==='urgent'?'üî¥':'üü¢'}</span><span class="quest-xp">+${q.xp_reward||100}</span></div></div>
${(q.tasks||[]).map((t,i)=>`<div class="quest-task ${t.done?'done':''}" onclick="togTask('${q.id}',${i})"><input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();togTask('${q.id}',${i})"><span>${t.text}</span></div>`).join('')}</div>`}

async function togTask(qid,i){const r=await api('/api/quests/'+qid+'/toggle-task','POST',{index:i});if(r?.completed&&!S.quests.find(q=>q.id===qid)?.completed)toast('‚öîÔ∏è –ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!','achievement');await loadAll()}
function newQuest(){const po=S.projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
showModal('–ö–≤–µ—Å—Ç',`<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="qN" placeholder="–ö–≤–µ—Å—Ç"></div><div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="qP"><option value="">‚Äî</option>${po}</select></div><div class="form-group"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select id="qPr"><option value="normal">–û–±—ã—á–Ω—ã–π</option><option value="urgent">–°—Ä–æ—á–Ω—ã–π</option></select></div><div class="form-group"><label>–ó–∞–¥–∞—á–∏ (–ø–æ —Å—Ç—Ä–æ–∫–µ)</label><textarea id="qT" placeholder="–ó–∞–¥–∞—á–∞ 1\n–ó–∞–¥–∞—á–∞ 2"></textarea></div>`,async()=>{const t=document.getElementById('qT').value.split('\n').filter(x=>x.trim());
await api('/api/quests','POST',{name:document.getElementById('qN').value,project_id:document.getElementById('qP').value,priority:document.getElementById('qPr').value,tasks:t,xp_reward:document.getElementById('qPr').value==='urgent'?250:150});
toast('‚öîÔ∏è –°–æ–∑–¥–∞–Ω!','success');closeModal();await loadAll()})}

// === SPRINTS ===
function rSprints(){const a=S.sprints.filter(s=>!s.completed),d=S.sprints.filter(s=>s.completed);
return `${a.length?`<div class="section-title">üèÉ –ê–∫—Ç–∏–≤–Ω—ã–µ (${a.length})</div>`:''}${a.map(s=>rSprintItem(s)).join('')}
${!a.length?'<div class="card"><p style="color:var(--text3)">–ù–µ—Ç —Å–ø—Ä–∏–Ω—Ç–æ–≤. –°–æ–∑–¥–∞–π –≤ –ø—Ä–æ–µ–∫—Ç–µ!</p></div>':''}
${d.length?`<div class="section-title" style="color:var(--text3)">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ (${d.length})</div>${d.slice(-3).map(s=>rSprintItem(s)).join('')}`:''}`}

function rSprintItem(s){const pn=S.projects.find(p=>p.id===s.project_id)?.name||'';
const tasks=s.tasks||[];const done=tasks.filter(t=>t.done).length;const pct=tasks.length?(done/tasks.length*100):0;
const overdue=s.end_date&&new Date(s.end_date)<new Date()&&!s.completed;
return `<div class="sprint-item"><div class="sprint-header"><div><strong>${s.name} #${s.number||1}</strong>${pn?`<span style="font-size:10px;color:var(--text3);margin-left:6px">üìÇ ${pn}</span>`:''}</div><div style="font-size:10px;color:${overdue?'var(--red)':'var(--text3)'}">${s.start_date?.slice(5)||''} ‚Üí ${s.end_date?.slice(5)||''}${overdue?' ‚ö†Ô∏è':''}</div></div>
<div class="sprint-progress"><div class="sprint-progress-fill" style="width:${pct}%"></div></div>
<div style="font-size:10px;color:var(--text3);margin-bottom:6px">${done}/${tasks.length} –∑–∞–¥–∞—á (${Math.round(pct)}%)</div>
${tasks.map((t,i)=>`<div class="quest-task ${t.done?'done':''}" onclick="togSprint('${s.id}',${i})"><input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();togSprint('${s.id}',${i})"><span>${t.text}</span></div>`).join('')}</div>`}

async function togSprint(sid,i){const r=await api('/api/sprints/'+sid+'/toggle-task','POST',{index:i});if(r?.completed)toast('üèÉ –°–ø—Ä–∏–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! +300 XP','achievement');await loadAll()}

// === RESEARCH ===
function rResearch(){return `<div class="card"><h2>üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à–∏</h2><div class="form-group"><input id="niIn" placeholder="–ù–∏—à–∞..."></div><div style="display:flex;gap:6px"><button class="btn btn-primary" onclick="aNiche()">üìä –ê–Ω–∞–ª–∏–∑</button><button class="btn btn-secondary" onclick="aScore()">üìà –°–∫–æ—Ä–∏–Ω–≥</button></div><div id="niRes" style="margin-top:12px"></div></div>
<div class="card"><h2>üîé Reddit</h2><div class="form-group"><input id="rdIn" placeholder="–ü–æ–∏—Å–∫ –±–æ–ª–µ–π..."></div><button class="btn btn-primary" onclick="sReddit()">üîé –ù–∞–π—Ç–∏</button><div id="rdRes" style="margin-top:12px"></div></div>
<div class="card"><h2>üìà –¢—Ä–µ–Ω–¥—ã</h2><div class="form-group"><input id="trIn" placeholder="–¢–µ–º–∞..."></div><button class="btn btn-primary" onclick="sTrends()">üìà –ê–Ω–∞–ª–∏–∑</button><div id="trRes" style="margin-top:12px"></div></div>
<div class="card"><h2>üé¨ YouTube</h2><div class="form-group"><input id="ytIn" placeholder="URL –≤–∏–¥–µ–æ..."></div><button class="btn btn-primary" onclick="aYoutube()">üé¨ –ê–Ω–∞–ª–∏–∑</button><div id="ytRes" style="margin-top:12px"></div></div>`}

async function aNiche(){const n=document.getElementById('niIn').value;if(!n)return;document.getElementById('niRes').innerHTML='<p style="color:var(--accent)">‚è≥...</p>';
const r=await api('/api/analyze-niche','POST',{niche:n});document.getElementById('niRes').innerHTML=r?.analysis?`<div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.analysis}</div>`:'<p style="color:var(--red)">–û—à–∏–±–∫–∞</p>';await loadAll()}

async function aScore(){const idea=document.getElementById('niIn').value;if(!idea)return;document.getElementById('niRes').innerHTML='<p style="color:var(--accent)">‚è≥...</p>';
const r=await api('/api/score-idea','POST',{idea});if(r&&r.total!==undefined){const c=r.total>=70?'var(--green)':r.total>=40?'var(--orange)':'var(--red)';
document.getElementById('niRes').innerHTML=`<div style="text-align:center;margin-bottom:12px"><div style="font-size:40px;font-weight:700;color:${c}">${r.total}/100</div><div style="color:var(--text2)">${r.verdict||''}</div></div><div class="stats-grid"><div class="stat-card"><div class="num">${r.market||0}</div><div class="label">–†—ã–Ω–æ–∫</div></div><div class="stat-card"><div class="num">${r.competition||0}</div><div class="label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è</div></div><div class="stat-card"><div class="num">${r.mvp_speed||0}</div><div class="label">MVP</div></div><div class="stat-card"><div class="num">${r.monetization||0}</div><div class="label">–ú–æ–Ω–µ—Ç–∏–∑.</div></div><div class="stat-card"><div class="num">${r.scalability||0}</div><div class="label">–ú–∞—Å—à—Ç–∞–±</div></div></div>`}}

async function sReddit(){const q=document.getElementById('rdIn').value;if(!q)return;document.getElementById('rdRes').innerHTML='<p style="color:var(--accent)">‚è≥...</p>';
const r=await api('/api/reddit-search','POST',{query:q});if(r?.posts){document.getElementById('rdRes').innerHTML=
r.posts.slice(0,5).map(p=>`<div class="reddit-post"><div class="post-title">${p.title}</div><div class="post-meta">r/${p.subreddit} | ‚¨ÜÔ∏è${p.score} | üí¨${p.comments} <button class="btn btn-sm btn-secondary" onclick="savePain('${p.title.replace(/'/g,"\\'")}','reddit','${q}','${p.url}')">üíæ</button></div>${p.text?`<div class="post-text">${p.text.slice(0,200)}</div>`:''}</div>`).join('')+
`<div class="card" style="margin-top:8px"><h3>üß† AI</h3><div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.analysis||''}</div></div>`;await loadAll()}}

async function sTrends(){const q=document.getElementById('trIn').value;if(!q)return;document.getElementById('trRes').innerHTML='<p style="color:var(--accent)">‚è≥...</p>';
const r=await api('/api/trends','POST',{query:q});document.getElementById('trRes').innerHTML=r?.analysis?`<div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.analysis}</div>`:'<p style="color:var(--red)">–û—à–∏–±–∫–∞</p>';await loadAll()}

async function aYoutube(){const u=document.getElementById('ytIn').value;if(!u)return;document.getElementById('ytRes').innerHTML='<p style="color:var(--accent)">‚è≥...</p>';
const r=await api('/api/youtube-analyze','POST',{url:u});document.getElementById('ytRes').innerHTML=r?.analysis?`<div style="white-space:pre-wrap;font-size:13px;line-height:1.5">${r.analysis}</div>`:'<p style="color:var(--red)">–û—à–∏–±–∫–∞</p>';await loadAll()}

// === PAINS ===
function rPains(){const ps=S.pains||[];
return `<div style="display:flex;gap:6px;margin-bottom:12px"><button class="btn btn-primary" onclick="newPain()">‚ûï –ë–æ–ª—å</button><span style="color:var(--text3);font-size:12px;align-self:center">${ps.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span></div>
${ps.length?ps.map(p=>`<div class="pain-item"><div style="display:flex;justify-content:space-between;align-items:center"><span>${p.text}</span><div style="display:flex;gap:4px"><span class="pain-status status-${p.status||'new'}">${p.status||'new'}</span>
<button class="btn btn-sm btn-secondary" onclick="updPain('${p.id}','validated')">‚úÖ</button>
<button class="btn btn-sm btn-secondary" onclick="updPain('${p.id}','rejected')">‚ùå</button>
<button class="btn btn-sm btn-danger btn-icon" onclick="delPain('${p.id}')">üóë</button></div></div>
<div class="pain-source">${p.source||'manual'}${p.niche?' | '+p.niche:''} | ${p.created_at?.slice(0,10)||''}</div></div>`).join(''):'<div class="card"><p style="color:var(--text3)">–ò—â–∏ –±–æ–ª–∏ –≤ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö –∏ —Å–æ—Ö—Ä–∞–Ω—è–π —Å—é–¥–∞!</p></div>'}`}

function newPain(){showModal('–ù–æ–≤–∞—è –±–æ–ª—å',`<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª–∏</label><textarea id="painT" placeholder="–õ—é–¥–∏ –∂–∞–ª—É—é—Ç—Å—è —á—Ç–æ..."></textarea></div><div class="form-group"><label>–ù–∏—à–∞</label><input id="painN" placeholder="SaaS, –∑–¥–æ—Ä–æ–≤—å–µ..."></div>`,async()=>{await api('/api/pains','POST',{text:document.getElementById('painT').value,niche:document.getElementById('painN').value});toast('üéØ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','success');closeModal();await loadAll()})}

async function savePain(text,src,niche,url){await api('/api/pains','POST',{text,source:src,niche,url});toast('üíæ –ë–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!','success');await loadAll()}
async function updPain(id,status){await api('/api/pains/'+id,'PUT',{status});await loadAll()}
async function delPain(id){await api('/api/pains/'+id,'DELETE');await loadAll()}

// === FUNNEL ===
function rFunnel(){const stages=['idea','validation','mvp','launch','growth'],names={idea:'üí° –ò–¥–µ—è',validation:'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è',mvp:'üõ† MVP',launch:'üöÄ –ó–∞–ø—É—Å–∫',growth:'üìà –†–æ—Å—Ç'};
const active=S.projects.filter(p=>p.status!=='archived');
return `<div class="card"><h2>üìà –í–æ—Ä–æ–Ω–∫–∞ –≥–∏–ø–æ—Ç–µ–∑</h2><p style="color:var(--text2);font-size:12px;margin-bottom:12px">–ö–Ω–æ–ø–∫–∞–º–∏ ‚Üê‚Üí –¥–≤–∏–≥–∞–π –ø—Ä–æ–µ–∫—Ç—ã –ø–æ —Å—Ç–∞–¥–∏—è–º</p></div>
${stages.map(s=>{const ps=active.filter(p=>(p.stage||'idea')===s);
return `<div class="card"><h2>${names[s]} <span style="color:var(--text3);font-size:13px">(${ps.length})</span></h2>
${ps.length?ps.map(p=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;margin-bottom:4px"><div><strong style="cursor:pointer" onclick="openProj('${p.id}')">${p.name}</strong>${p.revenue>0?`<span style="color:var(--green);margin-left:6px">$${p.revenue}</span>`:''}</div><div style="display:flex;gap:4px">${s!=='idea'?`<button class="btn btn-sm btn-secondary" onclick="chgStage('${p.id}','${stages[stages.indexOf(s)-1]}')">‚Üê</button>`:''} ${s!=='growth'?`<button class="btn btn-sm btn-primary" onclick="chgStage('${p.id}','${stages[stages.indexOf(s)+1]}')">‚Üí</button>`:''}</div></div>`).join(''):'<p style="color:var(--text3);font-size:12px">–ü—É—Å—Ç–æ</p>'}</div>`}).join('')}`}

// === ACHIEVEMENTS ===
function rAch(){const u=S.achievements.filter(a=>a.unlocked),l=S.achievements.filter(a=>!a.unlocked);
return `<div class="card"><h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (${u.length}/${S.achievements.length})</h2><div class="xp-bar" style="margin-bottom:12px"><div class="xp-bar-fill" style="width:${S.achievements.length?u.length/S.achievements.length*100:0}%"></div></div><div class="ach-grid">${u.map(a=>`<div class="ach-item" title="${a.desc}"><span class="ach-icon">${a.icon}</span><span class="ach-name">${a.name}</span></div>`).join('')}${l.map(a=>`<div class="ach-item locked" title="${a.desc}"><span class="ach-icon">${a.icon}</span><span class="ach-name">${a.name}</span></div>`).join('')}</div></div>`}

// === SETTINGS ===
function rSettings(){return `<div class="card"><h2>üíæ –î–∞–Ω–Ω—ã–µ</h2><p style="color:var(--text2);font-size:12px;margin-bottom:10px">–°–æ—Ö—Ä–∞–Ω–∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–µ—Ä–≤–µ—Ä–∞</p><div style="display:flex;gap:6px;flex-wrap:wrap"><a href="/api/export" class="btn btn-primary" download>üì• –°–∫–∞—á–∞—Ç—å</a><button class="btn btn-secondary" onclick="showImport()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button></div></div>
<div class="card"><h2>üìä –ò–Ω—Ñ–æ</h2><div style="font-size:12px;color:var(--text2);line-height:1.8">
<div>üìä –ü—Ä–æ–µ–∫—Ç–æ–≤: ${S.stats.total_projects||0} (–∞—Ä—Ö–∏–≤: ${S.stats.archived_projects||0})</div>
<div>‚öîÔ∏è –ö–≤–µ—Å—Ç–æ–≤: ${S.stats.total_quests||0} (‚úÖ ${S.stats.completed_quests||0})</div>
<div>üèÉ –°–ø—Ä–∏–Ω—Ç–æ–≤: ${(S.stats.active_sprints||0)+(S.stats.completed_sprints||0)} (‚úÖ ${S.stats.completed_sprints||0})</div>
<div>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: ${S.stats.total_messages||0}</div>
<div>üîç –ù–∏—à: ${S.stats.niches_analyzed||0}</div>
<div>üéØ –ë–æ–ª–µ–π: ${S.stats.saved_pains||0}</div>
<div>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: ${S.stats.achievements_unlocked||0}/${S.stats.achievements_total||0}</div>
<div>üî• –†–µ–∫–æ—Ä–¥ streak: ${S.player.max_streak||0}–¥</div></div></div>
<div class="card"><h2>‚ù§Ô∏è Health</h2><button class="btn btn-secondary" onclick="chkHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button><div id="hlRes" style="margin-top:8px"></div></div>`}

function showImport(){showModal('–ò–º–ø–æ—Ä—Ç',`<div class="form-group"><label>JSON —Ñ–∞–π–ª</label><input type="file" id="impF" accept=".json" style="padding:6px"></div><p style="color:var(--orange);font-size:11px">‚ö†Ô∏è –ü–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ!</p>`,async()=>{const f=document.getElementById('impF').files[0];if(!f)return;try{const d=JSON.parse(await f.text());const r=await api('/api/import','POST',d);if(r?.ok){toast('üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!','success');closeModal();await loadAll()}}catch(e){toast('‚ùå –û—à–∏–±–∫–∞','error')}})}
async function chkHealth(){const r=await fetch('/health').then(r=>r.json());document.getElementById('hlRes').innerHTML=`<pre style="font-size:11px;color:var(--green);background:var(--bg3);padding:10px;border-radius:8px">${JSON.stringify(r,null,2)}</pre>`}

// === MISSION ===
async function togMission(i){const r=await api('/api/mission/toggle','POST',{index:i});if(r){S.mission=r;if(r.completed)toast('üéØ –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +500 XP','achievement');await loadAll()}}

// === MODAL ===
function showModal(title,content,onOk){const m=document.createElement('div');m.className='modal-overlay';m.id='modal';
m.innerHTML=`<div class="modal"><h2>${title}</h2>${content}<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>${onOk?'<button class="btn btn-primary" id="modalOk">OK</button>':''}</div></div>`;
document.body.appendChild(m);m.addEventListener('click',e=>{if(e.target===m)closeModal()});if(onOk)document.getElementById('modalOk').addEventListener('click',onOk)}
function closeModal(){document.getElementById('modal')?.remove()}

loadAll();
</script>
</body>
</html>
