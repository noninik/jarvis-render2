<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JARVIS 2.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--bg2:#111827;--bg3:#1a2235;
  --card:rgba(26,34,53,.6);--glass:rgba(17,24,39,.4);
  --brd:rgba(0,255,255,.08);--brd-a:rgba(0,255,255,.3);
  --cyan:#00f0ff;--violet:#8b5cf6;--pink:#f472b6;
  --green:#34d399;--yellow:#fbbf24;--red:#f87171;
  --t1:#e2e8f0;--t2:#94a3b8;--t3:#475569;
  --sans:'Segoe UI',system-ui,sans-serif;
  --mono:'Courier New',monospace;
}
html,body{height:100%;font-family:var(--sans);background:var(--bg);color:var(--t1);overflow:hidden}

.app{display:grid;grid-template-columns:260px 1fr 280px;grid-template-rows:46px 1fr;height:100vh}

/* TOP */
.top{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 14px;
  background:rgba(10,14,23,.95);border-bottom:1px solid var(--brd)}
.logo{display:flex;align-items:center;gap:8px}
.logo b{font-family:var(--mono);font-size:.95rem;letter-spacing:3px;
  background:linear-gradient(135deg,var(--cyan),var(--violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo small{font-size:.55rem;color:var(--t3);background:var(--glass);padding:2px 5px;border-radius:3px}
.nav{display:flex;gap:3px}
.nav button{font-size:.7rem;padding:5px 12px;border-radius:6px;border:none;background:none;color:var(--t3);cursor:pointer;transition:.15s}
.nav button:hover{color:var(--t2);background:var(--glass)}
.nav button.on{color:var(--cyan);background:rgba(0,240,255,.1)}
.status{display:flex;align-items:center;gap:5px;font-size:.6rem;color:var(--t3)}
.status .dot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:p 2s infinite}
@keyframes p{0%,100%{opacity:1}50%{opacity:.3}}

/* LEFT */
.left{background:rgba(10,14,23,.7);border-right:1px solid var(--brd);display:flex;flex-direction:column;overflow:hidden}
.player{margin:8px;padding:10px;background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(0,240,255,.04));
  border:1px solid rgba(139,92,246,.15);border-radius:10px}
.player-top{display:flex;justify-content:space-between;margin-bottom:5px}
.player-rank{font-family:var(--mono);font-size:.6rem;color:var(--violet);font-weight:700}
.player-xp{font-family:var(--mono);font-size:.55rem;color:var(--t3)}
.xp-bar{width:100%;height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:6px}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--violet),var(--cyan));border-radius:2px;transition:width 1s}
.pstats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;text-align:center}
.pstats .v{font-family:var(--mono);font-size:.9rem;font-weight:700}
.pstats .l{font-size:.45rem;color:var(--t3);text-transform:uppercase}

.lscroll{flex:1;overflow-y:auto;padding:0 6px}
.lscroll::-webkit-scrollbar{width:3px}
.lscroll::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}
.slabel{font-family:var(--mono);font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:2px;
  padding:8px 4px 4px;display:flex;justify-content:space-between}
.slabel .cnt{font-size:.45rem;color:var(--cyan);background:rgba(0,240,255,.1);padding:1px 5px;border-radius:7px}

.mi{display:flex;align-items:center;gap:7px;padding:6px 7px;border-radius:7px;cursor:pointer;
  border-left:3px solid transparent;transition:.15s;font-size:.7rem}
.mi:hover{background:var(--glass)}
.mi.on{background:rgba(0,240,255,.08);border-left-color:var(--cyan)}
.mi .ic{width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;
  font-size:.7rem;background:var(--glass);flex-shrink:0}
.mi .nm{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.pi{display:flex;align-items:center;gap:7px;padding:5px 7px;border-radius:7px;cursor:pointer;transition:.15s;font-size:.65rem}
.pi:hover{background:var(--glass)}
.pi .dt{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.pi .pn{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pi .pr{font-family:var(--mono);font-size:.55rem;color:var(--green);flex-shrink:0}

.nbtn{margin:6px;padding:7px;border:1px dashed var(--brd-a);border-radius:7px;background:none;color:var(--cyan);
  font-family:var(--mono);font-size:.65rem;cursor:pointer;text-align:center;transition:.15s}
.nbtn:hover{background:rgba(0,240,255,.08);border-style:solid}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.view{display:none;flex:1;overflow:hidden}
.view.on{display:flex;flex-direction:column}

/* DASH */
.dash{flex:1;overflow-y:auto;padding:14px}
.dash::-webkit-scrollbar{width:3px}
.dash::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

/* MISSION */
.mission{background:linear-gradient(135deg,rgba(0,240,255,.04),rgba(139,92,246,.04));border:1px solid var(--brd);
  border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
.mission::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),var(--violet),transparent)}
.mission-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.mission-badge{font-family:var(--mono);font-size:.5rem;font-weight:700;color:var(--bg);background:linear-gradient(135deg,var(--cyan),var(--violet));
  padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:1px}
.mission-name{font-size:.85rem;font-weight:700;margin-left:8px}
.mission-timer{font-family:var(--mono);font-size:.6rem;color:var(--t3)}
.mission-bar{width:100%;height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-bottom:8px}
.mission-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:3px;transition:width .5s}
.mission-tasks{display:flex;flex-direction:column;gap:4px}
.mt{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:6px;cursor:pointer;transition:.15s;font-size:.7rem}
.mt:hover{background:var(--glass)}
.mt .ch{width:14px;height:14px;border:2px solid var(--t3);border-radius:3px;display:flex;align-items:center;
  justify-content:center;font-size:.45rem;flex-shrink:0;transition:.15s}
.mt.done .ch{background:var(--green);border-color:var(--green);color:var(--bg)}
.mt .tx{color:var(--t2)}
.mt.done .tx{color:var(--t3);text-decoration:line-through}

.sgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:14px}
.sc{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc:nth-child(1)::before{background:var(--cyan)}.sc:nth-child(2)::before{background:var(--violet)}
.sc:nth-child(3)::before{background:var(--green)}.sc:nth-child(4)::before{background:var(--pink)}
.sc .lb{font-family:var(--mono);font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.sc .vl{font-family:var(--mono);font-size:1.2rem;font-weight:800;margin-top:3px}
.sc:nth-child(1) .vl{color:var(--cyan)}.sc:nth-child(2) .vl{color:var(--violet)}
.sc:nth-child(3) .vl{color:var(--green)}.sc:nth-child(4) .vl{color:var(--pink)}
.sc .sb{font-size:.55rem;color:var(--t3);margin-top:2px}

.section-h{font-size:.85rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px}

.ngrid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:14px}
.nc{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:12px;cursor:pointer;transition:.2s}
.nc:hover{border-color:var(--brd-a);transform:translateY(-2px)}
.nc-top{display:flex;justify-content:space-between;margin-bottom:5px}
.nc-score{font-family:var(--mono);font-size:.6rem;font-weight:700;color:var(--green);background:rgba(52,211,153,.1);padding:2px 7px;border-radius:5px}
.nc-title{font-size:.78rem;font-weight:600;margin-bottom:4px}
.nc-desc{font-size:.6rem;color:var(--t2);line-height:1.5;margin-bottom:7px}
.nc-metrics{display:flex;gap:10px;padding-top:7px;border-top:1px solid var(--brd)}
.nc-m{text-align:center}
.nc-mv{font-family:var(--mono);font-size:.65rem;font-weight:700}
.nc-ml{font-size:.4rem;color:var(--t3);text-transform:uppercase}

/* CHAT */
.cwrap{flex:1;display:flex;flex-direction:column}
.msgs{flex:1;overflow-y:auto;padding:14px}
.msgs::-webkit-scrollbar{width:3px}
.msgs::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

.msg{display:flex;gap:8px;margin-bottom:12px;animation:fi .3s}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.msg .av{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:.75rem;flex-shrink:0}
.msg .av.u{background:linear-gradient(135deg,var(--violet),var(--pink))}
.msg .av.b{background:linear-gradient(135deg,var(--cyan),var(--violet))}
.msg .bd{flex:1;min-width:0}
.msg .sn{font-family:var(--mono);font-size:.55rem;font-weight:600;margin-bottom:2px}
.msg .sn.un{color:var(--violet)}.msg .sn.bn{color:var(--cyan)}
.msg .bl{font-size:.78rem;line-height:1.7;background:var(--card);border:1px solid var(--brd);
  border-radius:3px 12px 12px 12px;padding:9px 12px;white-space:pre-wrap;word-break:break-word}
.msg.usr .bl{background:rgba(139,92,246,.08);border-color:rgba(139,92,246,.15);border-radius:12px 3px 12px 12px}
.msg .tm{font-family:var(--mono);font-size:.45rem;color:var(--t3);margin-top:2px}

.typing{display:none;align-items:center;gap:4px;padding:5px 14px;font-family:var(--mono);font-size:.6rem;color:var(--cyan)}
.typing.on{display:flex}
.typing .d{width:4px;height:4px;border-radius:50%;background:var(--cyan);animation:bn 1.4s infinite}
.typing .d:nth-child(2){animation-delay:.2s}.typing .d:nth-child(3){animation-delay:.4s}
@keyframes bn{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-3px);opacity:1}}

.iarea{padding:8px 12px;border-top:1px solid var(--brd);background:rgba(10,14,23,.8)}
.irow{display:flex;gap:5px}
.irow textarea{flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;
  color:var(--t1);font-family:var(--sans);font-size:.8rem;resize:none;outline:none}
.irow textarea:focus{border-color:var(--brd-a)}
.irow textarea::placeholder{color:var(--t3)}
.sbtn{padding:8px 16px;background:linear-gradient(135deg,var(--cyan),var(--violet));border:none;border-radius:8px;
  color:var(--bg);font-family:var(--mono);font-size:.7rem;font-weight:700;cursor:pointer;letter-spacing:1px}
.sbtn:hover{box-shadow:0 0 14px rgba(0,240,255,.3)}
.sbtn:disabled{opacity:.4;cursor:not-allowed}
.ihint{font-family:var(--mono);font-size:.45rem;color:var(--t3);margin-top:3px;text-align:center}

/* RIGHT */
.right{background:rgba(10,14,23,.7);border-left:1px solid var(--brd);overflow-y:auto;padding:10px}
.right::-webkit-scrollbar{width:3px}
.right::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

.rsec{margin-bottom:12px}
.rtitle{font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:2px;margin-bottom:7px}

.qc{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:10px;margin-bottom:5px}
.qc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.qp{font-family:var(--mono);font-size:.45rem;font-weight:700;padding:2px 5px;border-radius:3px;text-transform:uppercase}
.qp.urg{color:var(--red);background:rgba(248,113,113,.1)}
.qp.nrm{color:var(--cyan);background:rgba(0,240,255,.1)}
.qxp{font-family:var(--mono);font-size:.5rem;color:var(--violet);font-weight:600}
.qn{font-size:.73rem;font-weight:600;margin-bottom:5px}
.qproj{font-size:.5rem;color:var(--t3);margin-bottom:4px;font-style:italic}
.qt{display:flex;align-items:center;gap:5px;padding:3px 0;cursor:pointer;font-size:.6rem}
.qt .qch{width:12px;height:12px;border:2px solid var(--t3);border-radius:3px;display:flex;align-items:center;
  justify-content:center;font-size:.4rem;flex-shrink:0;transition:.15s}
.qt.done .qch{background:var(--green);border-color:var(--green);color:var(--bg)}
.qt .qtx{color:var(--t2)}
.qt.done .qtx{color:var(--t3);text-decoration:line-through}
.qprog{display:flex;align-items:center;gap:4px;margin-top:5px;padding-top:5px;border-top:1px solid var(--brd)}
.qbar{flex:1;height:3px;background:var(--bg);border-radius:2px;overflow:hidden}
.qfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--cyan));transition:width .4s}
.qpct{font-family:var(--mono);font-size:.5rem;color:var(--t3)}

.agrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.ach{aspect-ratio:1;border-radius:8px;border:1px solid var(--brd);background:var(--glass);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}
.ach.ul{background:linear-gradient(135deg,rgba(0,240,255,.06),rgba(139,92,246,.06));border-color:rgba(0,240,255,.15)}
.ach.lk{opacity:.3}
.ach .ai{font-size:.9rem}
.ach .an{font-size:.4rem;color:var(--t3);text-align:center}
.ach.ul .an{color:var(--t2)}

/* XP popup */
.xpop{position:fixed;color:var(--violet);font-family:var(--mono);font-size:.8rem;font-weight:700;
  pointer-events:none;z-index:9999;animation:xpu 1.2s ease forwards}
@keyframes xpu{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-25px)}}

/* MODAL */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:5000;
  justify-content:center;align-items:center}
.mo.on{display:flex}
.mod{background:var(--bg2);border:1px solid var(--brd);border-radius:14px;padding:18px;width:90%;max-width:480px;
  animation:modin .3s}
@keyframes modin{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}
.mod h3{font-size:.95rem;margin-bottom:12px}
.mod .fld{margin-bottom:8px}
.mod .fld label{display:block;font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.mod .fld input,.mod .fld textarea{width:100%;padding:7px 9px;background:var(--bg3);border:1px solid var(--brd);
  border-radius:7px;color:var(--t1);font-family:var(--sans);font-size:.78rem;outline:none}
.mod .fld input:focus,.mod .fld textarea:focus{border-color:var(--brd-a)}
.mod .fld textarea{resize:vertical;min-height:50px}
.mod .acts{display:flex;gap:5px;justify-content:flex-end;margin-top:12px}
.mod .btn{padding:7px 16px;border-radius:7px;font-family:var(--mono);font-size:.65rem;font-weight:600;cursor:pointer;border:none;transition:.15s}
.mod .btn.pri{background:linear-gradient(135deg,var(--cyan),var(--violet));color:var(--bg)}
.mod .btn.sec{background:var(--glass);color:var(--t2);border:1px solid var(--brd)}
.mod-res{font-size:.75rem;line-height:1.6;white-space:pre-wrap;max-height:50vh;overflow-y:auto;margin-top:8px;
  padding:10px;background:var(--bg);border-radius:7px;border:1px solid var(--brd)}

@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .left,.right{display:none}
  .ngrid,.sgrid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">

<header class="top">
  <div class="logo"><b>JARVIS</b><small>v2.0</small></div>
  <nav class="nav">
    <button class="on" onclick="sw('dash',this)">üéØ –¶–µ–Ω—Ç—Ä</button>
    <button onclick="sw('chat',this)">üí¨ –ß–∞—Ç</button>
  </nav>
  <div class="status"><div class="dot"></div>Online</div>
</header>

<aside class="left">
  <div class="player">
    <div class="player-top">
      <span class="player-rank" id="pRank">‚ö° –£—Ä.1 ‚Äî –ù–æ–≤–∏—á–æ–∫</span>
      <span class="player-xp" id="pXP">0/1000 XP</span>
    </div>
    <div class="xp-bar"><div class="xp-fill" id="xFill" style="width:0%"></div></div>
    <div class="pstats">
      <div><div class="v" id="sP">0</div><div class="l">–ü—Ä–æ–µ–∫—Ç—ã</div></div>
      <div><div class="v" id="sQ">0</div><div class="l">–ö–≤–µ—Å—Ç—ã</div></div>
      <div><div class="v" id="sS">0</div><div class="l">üî•</div></div>
    </div>
  </div>
  <div class="lscroll">
    <div class="slabel">–†–µ–∂–∏–º—ã</div>
    <div id="modeList"></div>
    <div class="slabel" style="margin-top:6px">–ü—Ä–æ–µ–∫—Ç—ã <span class="cnt" id="pCnt">0</span></div>
    <div id="projList"></div>
  </div>
  <button class="nbtn" onclick="openM('mNew')">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
</aside>

<div class="main">

  <!-- DASHBOARD -->
  <div class="view on" id="v-dash">
    <div class="dash">
      <!-- MISSION -->
      <div class="mission" id="missionBlock"></div>

      <div class="sgrid">
        <div class="sc"><div class="lb">–ü—Ä–æ–µ–∫—Ç—ã</div><div class="vl" id="dP">0</div><div class="sb">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
        <div class="sc"><div class="lb">–ö–≤–µ—Å—Ç—ã</div><div class="vl" id="dQ">0</div><div class="sb">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
        <div class="sc"><div class="lb">MRR</div><div class="vl" id="dM">$0</div><div class="sb">–¥–æ—Ö–æ–¥</div></div>
        <div class="sc"><div class="lb">XP</div><div class="vl" id="dX">0</div><div class="sb">–≤—Å–µ–≥–æ</div></div>
      </div>

      <div class="section-h">üîç –ò–¥–µ–∏ –¥–ª—è –Ω–∏—à</div>
      <div class="ngrid" id="nicheGrid"></div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="view" id="v-chat">
    <div class="cwrap">
      <div class="msgs" id="msgs">
        <div class="msg"><div class="av b">J</div><div class="bd"><div class="sn bn">JARVIS 2.0</div>
        <div class="bl">–ü—Ä–∏–≤–µ—Ç, –∫–æ–º–∞–Ω–¥–∏—Ä! ü§ñ

–Ø ‚Äî JARVIS 2.0. –í–æ—Ç —á—Ç–æ —É–º–µ—é:

üîç ¬´–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∏—à—É: [–æ–ø–∏—Å–∞–Ω–∏–µ]¬ª
üìã ¬´–†–∞–∑–±–µ–π –Ω–∞ —Å–ø—Ä–∏–Ω—Ç—ã: [–ø—Ä–æ–µ–∫—Ç]¬ª
üí° ¬´–ö–∞–∫–∏–µ –Ω–∏—à–∏ —Å–µ–π—á–∞—Å —Ä–∞—Å—Ç—É—Ç?¬ª

–ß—Ç–æ —Å—Ç—Ä–æ–∏–º?</div><div class="tm">—Å–µ–π—á–∞—Å</div></div></div>
      </div>
      <div class="typing" id="typing"><div class="d"></div><div class="d"></div><div class="d"></div><span style="margin-left:5px">JARVIS –¥—É–º–∞–µ—Ç...</span></div>
      <div class="iarea">
        <div class="irow">
          <textarea id="inp" placeholder="–°–ø—Ä–æ—Å–∏ JARVIS..." rows="1" onkeydown="ik(event)"></textarea>
          <button class="sbtn" id="sbtn" onclick="send()">SEND</button>
        </div>
        <div class="ihint">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî —Å—Ç—Ä–æ–∫–∞</div>
      </div>
    </div>
  </div>
</div>

<aside class="right">
  <div class="rsec">
    <div class="rtitle">‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</div>
    <div id="questList"></div>
  </div>
  <div class="rsec">
    <div class="rtitle">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
    <div class="agrid" id="achList"></div>
  </div>
</aside>

</div>

<!-- MODALS -->
<div class="mo" id="mNew"><div class="mod">
  <h3>üöÄ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
  <div class="fld"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="npN" placeholder="SaaS –¥–ª—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤..."></div>
  <div class="fld"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="npD" placeholder="–ß—Ç–æ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç..."></textarea></div>
  <div class="fld"><label>–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</label><input id="npM" placeholder="$19/–º–µ—Å –ø–æ–¥–ø–∏—Å–∫–∞"></div>
  <div class="acts">
    <button class="btn sec" onclick="closeM('mNew')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn pri" onclick="createProj()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="mNiche"><div class="mod" style="max-width:560px">
  <h3>üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à–∏</h3>
  <div class="mod-res" id="nicheRes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div class="acts"><button class="btn sec" onclick="closeM('mNiche')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="mo" id="mRevenue"><div class="mod">
  <h3>üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h3>
  <div class="fld"><label>–°—É–º–º–∞ ($)</label><input id="revAmt" type="number" placeholder="100"></div>
  <div class="acts">
    <button class="btn sec" onclick="closeM('mRevenue')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn pri" onclick="addRevenue()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div></div>

<script>
const SID='w_'+Math.random().toString(36).substr(2,9);
let curMode='helper', revProjId='';

const MODES={
  helper:{n:"üí¨ –ü–æ–º–æ—â–Ω–∏–∫",e:"üí¨"},business:{n:"üìä –ë–∏–∑–Ω–µ—Å",e:"üìä"},content:{n:"‚úçÔ∏è –ö–æ–Ω—Ç–µ–Ω—Ç",e:"‚úçÔ∏è"},
  coder:{n:"üíª –ö–æ–¥",e:"üíª"},startup:{n:"üìã –°—Ç–∞—Ä—Ç–∞–ø",e:"üìã"},research:{n:"üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ",e:"üîç"},
  automate:{n:"üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è",e:"üöÄ"},copywriter:{n:"üìù –ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥",e:"üìù"},
  coach:{n:"üéØ –ö–æ—É—á",e:"üéØ"},translator:{n:"üåç –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫",e:"üåç"}
};

const NICHES=[
  {t:"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤",d:"478 –∞–ø–≤–æ—É—Ç–æ–≤ Reddit. –¢—Ä–µ–∫–∞–µ—Ç –¥–æ—Ö–æ–¥ –∏ –≤—Ä–µ–º—è.",s:"92%",tam:"$2.3M",comp:"–ù–∏–∑–∫–∞—è",mvp:"2 –Ω–µ–¥"},
  {t:"–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –¥–ª—è –≤–∏–¥–µ–æ",d:"340+ –∫–æ–º–º–µ–Ω—Ç–æ–≤ YouTube. –ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥.",s:"88%",tam:"$5.1M",comp:"–°—Ä–µ–¥–Ω—è—è",mvp:"3 –Ω–µ–¥"},
  {t:"–ü—Ä–æ—Å—Ç–∞—è CRM –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞",d:"–ì—Ä—É–ø–ø–∞ 45–ö. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π.",s:"76%",tam:"$8.7M",comp:"–í—ã—Å–æ–∫–∞—è",mvp:"4 –Ω–µ–¥"},
  {t:"–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–≤–æ–π—Å–æ–≤",d:"–¢–æ–ø-3 —Å –ø–ª–æ—Ö–∏–º UX, –Ω–µ—Ç –º–æ–±–∏–ª—å–Ω–æ–π.",s:"91%",tam:"$3.8M",comp:"–ù–∏–∑–∫–∞—è",mvp:"1.5 –Ω–µ–¥"},
];

document.addEventListener('DOMContentLoaded',()=>{renderModes();renderNiches();load()});

function sw(id,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.getElementById('v-'+id).classList.add('on');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  if(id==='chat'){document.getElementById('msgs').scrollTop=9e9;document.getElementById('inp').focus()}
}

function renderModes(){
  const l=document.getElementById('modeList');l.innerHTML='';
  for(const[k,m]of Object.entries(MODES)){
    const d=document.createElement('div');d.className='mi'+(k===curMode?' on':'');
    d.innerHTML=`<div class="ic">${m.e}</div><div class="nm">${m.n}</div>`;
    d.onclick=()=>{curMode=k;renderModes();fetch('/api/mode',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:SID,mode:k})})};
    l.appendChild(d)
  }
}

function renderNiches(){
  const g=document.getElementById('nicheGrid');g.innerHTML='';
  NICHES.forEach(n=>{
    const d=document.createElement('div');d.className='nc';d.onclick=()=>analyzeNiche(n.t);
    d.innerHTML=`<div class="nc-top"><span style="font-size:.55rem;color:var(--t3)">üîç</span><span class="nc-score">${n.s}</span></div>
      <div class="nc-title">${n.t}</div><div class="nc-desc">${n.d}</div>
      <div class="nc-metrics"><div class="nc-m"><div class="nc-mv">${n.tam}</div><div class="nc-ml">TAM</div></div>
      <div class="nc-m"><div class="nc-mv">${n.comp}</div><div class="nc-ml">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è</div></div>
      <div class="nc-m"><div class="nc-mv">${n.mvp}</div><div class="nc-ml">MVP</div></div></div>`;
    g.appendChild(d)
  })
}

// CHAT
function ik(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}

async function send(){
  const i=document.getElementById('inp'),t=i.value.trim();if(!t)return;
  i.value='';addMsg('user',t);showT(true);document.getElementById('sbtn').disabled=true;
  try{
    const r=await fetch('/api/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:SID,text:t})});
    const d=await r.json();showT(false);
    addMsg('bot',d.answer||d.error||'–û—à–∏–±–∫–∞',d.time);showXP('+25 XP')
  }catch(e){showT(false);addMsg('bot','‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è')}
  document.getElementById('sbtn').disabled=false;load()
}

function addMsg(role,text,time){
  const m=document.getElementById('msgs'),u=role==='user',
    now=time||new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    d=document.createElement('div');d.className='msg'+(u?' usr':'');
  d.innerHTML=`<div class="av ${u?'u':'b'}">${u?'üë§':'J'}</div><div class="bd">
    <div class="sn ${u?'un':'bn'}">${u?'–í—ã':'JARVIS 2.0'}</div>
    <div class="bl">${esc(text)}</div><div class="tm">${now}</div></div>`;
  m.appendChild(d);m.scrollTop=9e9
}

function showT(s){document.getElementById('typing').classList.toggle('on',s)}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

function showXP(text){
  const x=document.createElement('div');x.className='xpop';x.textContent=text;
  x.style.left=Math.random()*60+20+'%';x.style.top='50%';
  document.body.appendChild(x);setTimeout(()=>x.remove(),1200)
}

// LOAD DATA
async function load(){
  try{
    const[stats,mission,ach]=await Promise.all([
      fetch('/api/stats').then(r=>r.json()),
      fetch('/api/mission').then(r=>r.json()),
      fetch('/api/achievements').then(r=>r.json())
    ]);
    const p=stats.player||{};
    document.getElementById('pRank').textContent=`‚ö° –£—Ä.${p.level||1} ‚Äî ${p.rank||'–ù–æ–≤–∏—á–æ–∫'}`;
    document.getElementById('pXP').textContent=`${p.xp||0}/${p.xp_to_next||1000} XP`;
    document.getElementById('xFill').style.width=(p.xp_to_next?Math.round(p.xp/p.xp_to_next*100):0)+'%';
    document.getElementById('sP').textContent=stats.active_projects||0;
    document.getElementById('sQ').textContent=stats.active_quests||0;
    document.getElementById('sS').textContent=p.streak||0;
    document.getElementById('dP').textContent=stats.active_projects||0;
    document.getElementById('dQ').textContent=stats.active_quests||0;
    document.getElementById('dM').textContent='$'+(stats.total_revenue||0);
    document.getElementById('dX').textContent=p.total_xp||0;

    // MISSION
    renderMission(mission);
    // ACHIEVEMENTS
    renderAch(ach);
    // PROJECTS
    loadProjects();
    // QUESTS
    loadQuests();
  }catch(e){console.log('Load err:',e)}
}

function renderMission(m){
  const b=document.getElementById('missionBlock');
  if(!m||!m.tasks){b.innerHTML='<div style="text-align:center;color:var(--t3);font-size:.7rem">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Å—Å–∏–∏...</div>';return}
  const done=m.tasks.filter(t=>t.done).length,total=m.tasks.length,pct=total?Math.round(done/total*100):0;
  let end='';
  try{const d=new Date(m.week_end);const now=new Date();const diff=Math.max(0,Math.ceil((d-now)/(1000*60*60*24)));end=diff+'–¥'}catch(e){end='‚Äî'}
  let tasks='';
  m.tasks.forEach((t,i)=>{
    tasks+=`<div class="mt ${t.done?'done':''}" onclick="toggleMission(${i})"><div class="ch">${t.done?'‚úì':''}</div><span class="tx">${t.text}</span></div>`
  });
  b.innerHTML=`<div class="mission-top"><div style="display:flex;align-items:center"><span class="mission-badge">üéØ –ú–∏—Å—Å–∏—è –Ω–µ–¥–µ–ª–∏</span>
    <span class="mission-name">${m.name}</span></div><div class="mission-timer">‚è± ${end}</div></div>
    <div class="mission-bar"><div class="mission-fill" style="width:${pct}%"></div></div>
    <div class="mission-tasks">${tasks}</div>`
}

async function toggleMission(idx){
  try{await fetch('/api/mission/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:idx})});load()}catch(e){}
}

function renderAch(list){
  const g=document.getElementById('achList');g.innerHTML='';
  (list||[]).forEach(a=>{
    const d=document.createElement('div');d.className='ach '+(a.unlocked?'ul':'lk');
    d.innerHTML=`<div class="ai">${a.icon}</div><div class="an">${a.name}</div>`;
    d.title=a.desc;g.appendChild(d)
  })
}

async function loadProjects(){
  try{
    const r=await fetch('/api/projects');const d=await r.json();
    const list=document.getElementById('projList'),projects=(d.projects||[]).filter(p=>p.status==='active');
    document.getElementById('pCnt').textContent=projects.length;
    list.innerHTML='';
    if(!projects.length){list.innerHTML='<div style="padding:6px;font-size:.6rem;color:var(--t3)">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>';return}
    projects.forEach(p=>{
      const d=document.createElement('div');d.className='pi';
      d.innerHTML=`<div class="dt" style="background:var(--green)"></div><div class="pn">${p.name}</div><div class="pr">$${p.revenue||0}</div>`;
      d.onclick=()=>{revProjId=p.id;openM('mRevenue')};
      list.appendChild(d)
    })
  }catch(e){}
}

async function loadQuests(){
  try{
    const r=await fetch('/api/quests');const d=await r.json();
    const list=document.getElementById('questList'),quests=(d.quests||[]).filter(q=>!q.completed).slice(0,5);
    list.innerHTML='';
    if(!quests.length){list.innerHTML='<div class="qc"><div class="qn" style="font-size:.65rem;color:var(--t3)">–°–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç ‚Äî –∫–≤–µ—Å—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div></div>';return}
    quests.forEach(q=>{
      const tasks=q.tasks||[],done=tasks.filter(t=>t.done).length,total=tasks.length||1,pct=Math.round(done/total*100);
      let th='';tasks.forEach((t,i)=>{
        th+=`<div class="qt ${t.done?'done':''}" onclick="toggleTask('${q.id}',${i})"><div class="qch">${t.done?'‚úì':''}</div><span class="qtx">${t.text||t}</span></div>`
      });
      // –ù–∞–π–¥—ë–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞
      let projName=q.project_id?'':'';
      const div=document.createElement('div');div.className='qc';
      div.innerHTML=`<div class="qc-top"><span class="qp ${q.priority==='urgent'?'urg':'nrm'}">${q.priority==='urgent'?'üî• –°—Ä–æ—á–Ω–æ':'üìã –û–±—ã—á–Ω—ã–π'}</span>
        <span class="qxp">+${q.xp_reward||100} XP</span></div>
        <div class="qn">${q.name}</div>${th}
        <div class="qprog"><div class="qbar"><div class="qfill" style="width:${pct}%"></div></div><span class="qpct">${done}/${total}</span></div>`;
      list.appendChild(div)
    })
  }catch(e){}
}

async function toggleTask(qid,idx){
  try{
    const r=await fetch('/api/quests');const d=await r.json();
    const q=(d.quests||[]).find(x=>x.id===qid);if(!q)return;
    q.tasks[idx].done=!q.tasks[idx].done;
    const allDone=q.tasks.every(t=>t.done);
    await fetch('/api/quests/'+qid,{method:'PUT',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({tasks:q.tasks,completed:allDone})});
    if(allDone)showXP(`+${q.xp_reward||100} XP`);
    load()
  }catch(e){}
}

// MODALS
function openM(id){document.getElementById(id).classList.add('on')}
function closeM(id){document.getElementById(id).classList.remove('on')}

async function createProj(){
  const n=document.getElementById('npN').value.trim();
  if(!n)return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  try{
    await fetch('/api/projects',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:n,description:document.getElementById('npD').value,monetization:document.getElementById('npM').value})});
    closeM('mNew');document.getElementById('npN').value='';document.getElementById('npD').value='';document.getElementById('npM').value='';
    showXP('+100 XP');
    // –ñ–¥—ë–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–≤–µ—Å—Ç–æ–≤
    setTimeout(load,3000);load()
  }catch(e){alert('–û—à–∏–±–∫–∞')}
}

async function addRevenue(){
  const amt=parseInt(document.getElementById('revAmt').value)||0;
  if(!amt||!revProjId)return;
  try{
    await fetch(`/api/projects/${revProjId}/revenue`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amt})});
    closeM('mRevenue');document.getElementById('revAmt').value='';showXP('+50 XP');load()
  }catch(e){alert('–û—à–∏–±–∫–∞')}
}

async function analyzeNiche(niche){
  openM('mNiche');document.getElementById('nicheRes').textContent='‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é: '+niche+'...\n\n10-30 —Å–µ–∫—É–Ω–¥...';
  try{
    const r=await fetch('/api/analyze-niche',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({niche})});
    const d=await r.json();document.getElementById('nicheRes').textContent=d.analysis||d.error||'–û—à–∏–±–∫–∞';showXP('+50 XP');load()
  }catch(e){document.getElementById('nicheRes').textContent='‚ùå –û—à–∏–±–∫–∞'}
}
</script>
</body>
</html>
