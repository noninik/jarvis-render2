<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JARVIS 2.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--bg2:#111827;--bg3:#1a2235;
  --card:rgba(26,34,53,.6);--glass:rgba(17,24,39,.4);
  --brd:rgba(0,255,255,.08);--brd-a:rgba(0,255,255,.3);
  --cyan:#00f0ff;--violet:#8b5cf6;--pink:#f472b6;
  --green:#34d399;--yellow:#fbbf24;--red:#f87171;
  --t1:#e2e8f0;--t2:#94a3b8;--t3:#475569;
  --sans:'Segoe UI',system-ui,sans-serif;
  --mono:'Courier New',monospace;
}
html,body{height:100%;font-family:var(--sans);background:var(--bg);color:var(--t1);overflow:hidden}

/* LAYOUT */
.app{display:grid;grid-template-columns:280px 1fr 300px;grid-template-rows:48px 1fr;height:100vh}

/* TOP */
.top{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 16px;
  background:rgba(10,14,23,.95);border-bottom:1px solid var(--brd)}
.logo{display:flex;align-items:center;gap:8px}
.logo b{font-family:var(--mono);font-size:1rem;letter-spacing:3px;
  background:linear-gradient(135deg,var(--cyan),var(--violet));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo small{font-size:.6rem;color:var(--t3);background:var(--glass);padding:2px 6px;border-radius:3px}
.nav{display:flex;gap:4px}
.nav button{font-size:.75rem;padding:6px 14px;border-radius:6px;border:none;background:none;color:var(--t3);cursor:pointer}
.nav button:hover{color:var(--t2);background:var(--glass)}
.nav button.on{color:var(--cyan);background:rgba(0,240,255,.1)}
.status{display:flex;align-items:center;gap:6px;font-size:.65rem;color:var(--t3)}
.status .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* LEFT */
.left{background:rgba(10,14,23,.7);border-right:1px solid var(--brd);display:flex;flex-direction:column;overflow:hidden}
.player{margin:10px;padding:12px;background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(0,240,255,.04));
  border:1px solid rgba(139,92,246,.15);border-radius:12px}
.player-top{display:flex;justify-content:space-between;margin-bottom:6px}
.player-rank{font-family:var(--mono);font-size:.65rem;color:var(--violet);font-weight:700}
.player-xp{font-family:var(--mono);font-size:.6rem;color:var(--t3)}
.xp-bar{width:100%;height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:8px}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--violet),var(--cyan));border-radius:2px;transition:width 1s}
.player-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;text-align:center}
.player-stats .v{font-family:var(--mono);font-size:1rem;font-weight:700}
.player-stats .l{font-size:.5rem;color:var(--t3);text-transform:uppercase}

.left-scroll{flex:1;overflow-y:auto;padding:0 8px}
.left-scroll::-webkit-scrollbar{width:3px}
.left-scroll::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}
.section-label{font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:2px;
  padding:10px 4px 4px;display:flex;justify-content:space-between}
.section-label .cnt{font-size:.5rem;color:var(--cyan);background:rgba(0,240,255,.1);padding:1px 6px;border-radius:7px}

.mode-item{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:8px;cursor:pointer;
  border-left:3px solid transparent;transition:.15s}
.mode-item:hover{background:var(--glass)}
.mode-item.on{background:rgba(0,240,255,.08);border-left-color:var(--cyan)}
.mode-item .icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:.8rem;background:var(--glass)}
.mode-item .name{font-size:.75rem;font-weight:600}

.proj-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer;transition:.15s}
.proj-item:hover{background:var(--glass)}
.proj-item .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.proj-item .pname{font-size:.7rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.proj-item .prev{font-family:var(--mono);font-size:.6rem;color:var(--green);flex-shrink:0}

.new-btn{margin:8px;padding:8px;border:1px dashed var(--brd-a);border-radius:8px;background:none;color:var(--cyan);
  font-family:var(--mono);font-size:.7rem;cursor:pointer;text-align:center;transition:.15s}
.new-btn:hover{background:rgba(0,240,255,.08);border-style:solid}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.view{display:none;flex:1;overflow:hidden}
.view.on{display:flex;flex-direction:column}

/* DASHBOARD */
.dash{flex:1;overflow-y:auto;padding:16px}
.dash::-webkit-scrollbar{width:3px}
.dash::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.stat-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card:nth-child(1)::before{background:var(--cyan)}
.stat-card:nth-child(2)::before{background:var(--violet)}
.stat-card:nth-child(3)::before{background:var(--green)}
.stat-card:nth-child(4)::before{background:var(--pink)}
.stat-card .label{font-family:var(--mono);font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-family:var(--mono);font-size:1.4rem;font-weight:800;margin-top:4px}
.stat-card:nth-child(1) .value{color:var(--cyan)}
.stat-card:nth-child(2) .value{color:var(--violet)}
.stat-card:nth-child(3) .value{color:var(--green)}
.stat-card:nth-child(4) .value{color:var(--pink)}
.stat-card .sub{font-size:.6rem;color:var(--t3);margin-top:2px}

.niche-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px}
.niche-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;cursor:pointer;transition:.2s}
.niche-card:hover{border-color:var(--brd-a);transform:translateY(-2px)}
.niche-card .nc-top{display:flex;justify-content:space-between;margin-bottom:6px}
.niche-card .nc-score{font-family:var(--mono);font-size:.65rem;font-weight:700;color:var(--green);
  background:rgba(52,211,153,.1);padding:2px 8px;border-radius:5px}
.niche-card .nc-title{font-size:.85rem;font-weight:600;margin-bottom:4px}
.niche-card .nc-desc{font-size:.65rem;color:var(--t2);line-height:1.5;margin-bottom:8px}
.niche-card .nc-metrics{display:flex;gap:12px;padding-top:8px;border-top:1px solid var(--brd)}
.niche-card .nc-m{text-align:center}
.niche-card .nc-mv{font-family:var(--mono);font-size:.7rem;font-weight:700}
.niche-card .nc-ml{font-size:.45rem;color:var(--t3);text-transform:uppercase}

/* CHAT */
.chat-wrap{flex:1;display:flex;flex-direction:column}
.messages{flex:1;overflow-y:auto;padding:16px}
.messages::-webkit-scrollbar{width:3px}
.messages::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

.msg{display:flex;gap:8px;margin-bottom:14px;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg .avatar{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:.8rem;flex-shrink:0}
.msg .avatar.user{background:linear-gradient(135deg,var(--violet),var(--pink))}
.msg .avatar.bot{background:linear-gradient(135deg,var(--cyan),var(--violet))}
.msg .body{flex:1;min-width:0}
.msg .sender{font-family:var(--mono);font-size:.6rem;font-weight:600;margin-bottom:3px}
.msg .sender.u{color:var(--violet)}
.msg .sender.b{color:var(--cyan)}
.msg .bubble{font-size:.8rem;line-height:1.7;background:var(--card);border:1px solid var(--brd);
  border-radius:4px 14px 14px 14px;padding:10px 14px;white-space:pre-wrap;word-break:break-word}
.msg.user .bubble{background:rgba(139,92,246,.08);border-color:rgba(139,92,246,.15);border-radius:14px 4px 14px 14px}
.msg .time{font-family:var(--mono);font-size:.5rem;color:var(--t3);margin-top:3px}

.typing{display:none;align-items:center;gap:4px;padding:6px 16px;font-family:var(--mono);font-size:.65rem;color:var(--cyan)}
.typing.on{display:flex}
.typing .d{width:4px;height:4px;border-radius:50%;background:var(--cyan);animation:bounce 1.4s infinite}
.typing .d:nth-child(2){animation-delay:.2s}
.typing .d:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-4px);opacity:1}}

.input-area{padding:10px 14px;border-top:1px solid var(--brd);background:rgba(10,14,23,.8)}
.input-row{display:flex;gap:6px}
.input-row textarea{flex:1;padding:10px 12px;background:var(--bg3);border:1px solid var(--brd);border-radius:10px;
  color:var(--t1);font-family:var(--sans);font-size:.85rem;resize:none;outline:none}
.input-row textarea:focus{border-color:var(--brd-a)}
.input-row textarea::placeholder{color:var(--t3)}
.send-btn{padding:10px 20px;background:linear-gradient(135deg,var(--cyan),var(--violet));border:none;border-radius:10px;
  color:var(--bg);font-family:var(--mono);font-size:.75rem;font-weight:700;cursor:pointer;letter-spacing:1px}
.send-btn:hover{box-shadow:0 0 16px rgba(0,240,255,.3)}
.send-btn:disabled{opacity:.4;cursor:not-allowed}
.input-hint{font-family:var(--mono);font-size:.5rem;color:var(--t3);margin-top:4px;text-align:center}

/* RIGHT */
.right{background:rgba(10,14,23,.7);border-left:1px solid var(--brd);overflow-y:auto;padding:12px}
.right::-webkit-scrollbar{width:3px}
.right::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}

.right-section{margin-bottom:14px}
.right-title{font-family:var(--mono);font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:2px;
  margin-bottom:8px;display:flex;align-items:center;gap:6px}

.quest-card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:12px;margin-bottom:6px}
.quest-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.quest-priority{font-family:var(--mono);font-size:.5rem;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase}
.quest-priority.urgent{color:var(--red);background:rgba(248,113,113,.1)}
.quest-priority.normal{color:var(--cyan);background:rgba(0,240,255,.1)}
.quest-xp{font-family:var(--mono);font-size:.55rem;color:var(--violet);font-weight:600}
.quest-name{font-size:.8rem;font-weight:600;margin-bottom:6px}
.quest-task{display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer}
.quest-task .check{width:14px;height:14px;border:2px solid var(--t3);border-radius:3px;display:flex;
  align-items:center;justify-content:center;font-size:.5rem;flex-shrink:0;transition:.15s}
.quest-task.done .check{background:var(--green);border-color:var(--green);color:var(--bg)}
.quest-task .task-text{font-size:.65rem;color:var(--t2)}
.quest-task.done .task-text{color:var(--t3);text-decoration:line-through}
.quest-progress{display:flex;align-items:center;gap:5px;margin-top:6px;padding-top:6px;border-top:1px solid var(--brd)}
.quest-bar{flex:1;height:3px;background:var(--bg);border-radius:2px;overflow:hidden}
.quest-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--cyan));transition:width .4s}
.quest-pct{font-family:var(--mono);font-size:.55rem;color:var(--t3)}

.achievements{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.ach{aspect-ratio:1;border-radius:10px;border:1px solid var(--brd);background:var(--glass);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}
.ach.unlocked{background:linear-gradient(135deg,rgba(0,240,255,.06),rgba(139,92,246,.06));border-color:rgba(0,240,255,.15)}
.ach.locked{opacity:.35}
.ach .ach-icon{font-size:1rem}
.ach .ach-name{font-size:.45rem;color:var(--t3);text-align:center}
.ach.unlocked .ach-name{color:var(--t2)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:5000;
  justify-content:center;align-items:center}
.modal-overlay.on{display:flex}
.modal{background:var(--bg2);border:1px solid var(--brd);border-radius:16px;padding:20px;width:90%;max-width:500px;
  animation:modalIn .3s}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:none}}
.modal h3{font-size:1rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.modal .field{margin-bottom:10px}
.modal .field label{display:block;font-family:var(--mono);font-size:.6rem;color:var(--t3);text-transform:uppercase;
  letter-spacing:1px;margin-bottom:3px}
.modal .field input,.modal .field textarea{width:100%;padding:8px 10px;background:var(--bg3);border:1px solid var(--brd);
  border-radius:8px;color:var(--t1);font-family:var(--sans);font-size:.8rem;outline:none}
.modal .field input:focus,.modal .field textarea:focus{border-color:var(--brd-a)}
.modal .field textarea{resize:vertical;min-height:60px}
.modal .actions{display:flex;gap:6px;justify-content:flex-end;margin-top:14px}
.modal .btn{padding:8px 18px;border-radius:8px;font-family:var(--mono);font-size:.7rem;font-weight:600;cursor:pointer;border:none}
.modal .btn.primary{background:linear-gradient(135deg,var(--cyan),var(--violet));color:var(--bg)}
.modal .btn.secondary{background:var(--glass);color:var(--t2);border:1px solid var(--brd)}

.modal-result{font-size:.8rem;line-height:1.6;white-space:pre-wrap;max-height:55vh;overflow-y:auto;margin-top:10px;
  padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--brd)}

@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .left,.right{display:none}
  .niche-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">

  <!-- TOPBAR -->
  <header class="top">
    <div class="logo"><b>JARVIS</b><small>v2.0</small></div>
    <nav class="nav">
      <button class="on" onclick="switchView('dash',this)">üéØ –¶–µ–Ω—Ç—Ä</button>
      <button onclick="switchView('chat',this)">üí¨ –ß–∞—Ç</button>
    </nav>
    <div class="status"><div class="dot"></div>Online ¬∑ Groq</div>
  </header>

  <!-- LEFT SIDEBAR -->
  <aside class="left">
    <div class="player">
      <div class="player-top">
        <span class="player-rank" id="playerRank">‚ö° –£—Ä.1 ‚Äî –ù–æ–≤–∏—á–æ–∫</span>
        <span class="player-xp" id="playerXP">0/1000 XP</span>
      </div>
      <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
      <div class="player-stats">
        <div><div class="v" id="statProj">0</div><div class="l">–ü—Ä–æ–µ–∫—Ç—ã</div></div>
        <div><div class="v" id="statQuest">0</div><div class="l">–ö–≤–µ—Å—Ç—ã</div></div>
        <div><div class="v" id="statStreak">0</div><div class="l">üî•</div></div>
      </div>
    </div>

    <div class="left-scroll">
      <div class="section-label">–†–µ–∂–∏–º—ã <span class="cnt">10</span></div>
      <div id="modeList"></div>

      <div class="section-label" style="margin-top:8px">–ü—Ä–æ–µ–∫—Ç—ã <span class="cnt" id="projCnt">0</span></div>
      <div id="projList"></div>
    </div>

    <button class="new-btn" onclick="openNewProject()">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <!-- DASHBOARD -->
    <div class="view on" id="v-dash">
      <div class="dash">
        <div class="stats-grid">
          <div class="stat-card"><div class="label">–ü—Ä–æ–µ–∫—Ç—ã</div><div class="value" id="dashProj">0</div><div class="sub">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
          <div class="stat-card"><div class="label">–ö–≤–µ—Å—Ç—ã</div><div class="value" id="dashQuest">0</div><div class="sub">–∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
          <div class="stat-card"><div class="label">MRR</div><div class="value" id="dashMRR">$0</div><div class="sub">–¥–æ—Ö–æ–¥</div></div>
          <div class="stat-card"><div class="label">XP</div><div class="value" id="dashXP">0</div><div class="sub">–≤—Å–µ–≥–æ</div></div>
        </div>

        <h3 style="margin-bottom:10px;font-size:.9rem">üîç –ò–¥–µ–∏ –¥–ª—è –Ω–∏—à</h3>
        <div class="niche-grid" id="nicheGrid"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="view" id="v-chat">
      <div class="chat-wrap">
        <div class="messages" id="chatMessages">
          <div class="msg">
            <div class="avatar bot">J</div>
            <div class="body">
              <div class="sender b">JARVIS 2.0</div>
              <div class="bubble">–ü—Ä–∏–≤–µ—Ç, –∫–æ–º–∞–Ω–¥–∏—Ä! ü§ñ

–Ø ‚Äî JARVIS 2.0. –í–æ—Ç —á—Ç–æ —É–º–µ—é:

üîç ¬´–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∏—à—É: [–æ–ø–∏—Å–∞–Ω–∏–µ]¬ª
üìã ¬´–†–∞–∑–±–µ–π –Ω–∞ —Å–ø—Ä–∏–Ω—Ç—ã: [–ø—Ä–æ–µ–∫—Ç]¬ª
üí° ¬´–ö–∞–∫–∏–µ –Ω–∏—à–∏ —Å–µ–π—á–∞—Å —Ä–∞—Å—Ç—É—Ç?¬ª
üìä ¬´–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –¥–ª—è: [–∏–¥–µ—è]¬ª

–ß—Ç–æ —Å—Ç—Ä–æ–∏–º?</div>
              <div class="time">—Å–µ–π—á–∞—Å</div>
            </div>
          </div>
        </div>
        <div class="typing" id="typing"><div class="d"></div><div class="d"></div><div class="d"></div><span style="margin-left:6px">JARVIS –¥—É–º–∞–µ—Ç...</span></div>
        <div class="input-area">
          <div class="input-row">
            <textarea id="chatInput" placeholder="–°–ø—Ä–æ—Å–∏ JARVIS..." rows="1" onkeydown="handleKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">SEND</button>
          </div>
          <div class="input-hint">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <aside class="right">
    <div class="right-section">
      <div class="right-title">‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</div>
      <div id="questList"></div>
    </div>

    <div class="right-section">
      <div class="right-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
      <div class="achievements">
        <div class="ach unlocked"><div class="ach-icon">üöÄ</div><div class="ach-name">–°—Ç–∞—Ä—Ç</div></div>
        <div class="ach unlocked"><div class="ach-icon">üí¨</div><div class="ach-name">–ü–µ—Ä–≤—ã–π —á–∞—Ç</div></div>
        <div class="ach locked"><div class="ach-icon">üí∞</div><div class="ach-name">$1K</div></div>
        <div class="ach locked"><div class="ach-icon">‚ö°</div><div class="ach-name">100 XP</div></div>
        <div class="ach locked"><div class="ach-icon">üî•</div><div class="ach-name">7–¥ —Å–µ—Ä–∏—è</div></div>
        <div class="ach locked"><div class="ach-icon">üëë</div><div class="ach-name">–ú–∞–≥–Ω–∞—Ç</div></div>
      </div>
    </div>
  </aside>
</div>

<!-- NEW PROJECT MODAL -->
<div class="modal-overlay" id="modalNewProject">
  <div class="modal">
    <h3>üöÄ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="npName" placeholder="SaaS –¥–ª—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤..."></div>
    <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="npDesc" placeholder="–ß—Ç–æ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç..."></textarea></div>
    <div class="field"><label>–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</label><input id="npMon" placeholder="$19/–º–µ—Å –ø–æ–¥–ø–∏—Å–∫–∞"></div>
    <div class="actions">
      <button class="btn secondary" onclick="closeModal('modalNewProject')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" onclick="createProject()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- NICHE ANALYSIS MODAL -->
<div class="modal-overlay" id="modalNiche">
  <div class="modal" style="max-width:600px">
    <h3>üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à–∏</h3>
    <div class="modal-result" id="nicheResult">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="actions">
      <button class="btn secondary" onclick="closeModal('modalNiche')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
// === STATE ===
const SID = 'web_' + Math.random().toString(36).substr(2,9);
let currentMode = 'helper';
let chatContext = [];

const MODES = {
  helper:{name:"üí¨ –ü–æ–º–æ—â–Ω–∏–∫",emoji:"üí¨"},
  business:{name:"üìä –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫",emoji:"üìä"},
  content:{name:"‚úçÔ∏è –ö–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä",emoji:"‚úçÔ∏è"},
  coder:{name:"üíª –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç",emoji:"üíª"},
  startup:{name:"üìã –°—Ç–∞—Ä—Ç–∞–ø-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",emoji:"üìã"},
  research:{name:"üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å",emoji:"üîç"},
  automate:{name:"üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä",emoji:"üöÄ"},
  copywriter:{name:"üìù –ö–æ–ø–∏—Ä–∞–π—Ç–µ—Ä",emoji:"üìù"},
  coach:{name:"üéØ –ö–æ—É—á",emoji:"üéØ"},
  translator:{name:"üåç –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫",emoji:"üåç"},
};

const NICHES = [
  {title:"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤",desc:"–¢—Ä–µ–∫–∞–µ—Ç –¥–æ—Ö–æ–¥ –∏ –≤—Ä–µ–º—è. 478 –∞–ø–≤–æ—É—Ç–æ–≤ –Ω–∞ Reddit.",score:"92%",tam:"$2.3M",comp:"–ù–∏–∑–∫–∞—è",mvp:"2 –Ω–µ–¥"},
  {title:"–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –¥–ª—è –≤–∏–¥–µ–æ",desc:"–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –∏ –æ–∑–≤—É—á–∫–∞. 340+ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ YouTube.",score:"88%",tam:"$5.1M",comp:"–°—Ä–µ–¥–Ω—è—è",mvp:"3 –Ω–µ–¥"},
  {title:"–ü—Ä–æ—Å—Ç–∞—è CRM –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞",desc:"–ë–µ–∑ –¥–µ—Å—è—Ç–∫–æ–≤ –ª–∏—à–Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ì—Ä—É–ø–ø–∞ 45–ö –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π.",score:"76%",tam:"$8.7M",comp:"–í—ã—Å–æ–∫–∞—è",mvp:"4 –Ω–µ–¥"},
  {title:"–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤",desc:"–¢–æ–ø-3 —Å –ø–ª–æ—Ö–∏–º UX, –Ω–µ—Ç –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏.",score:"91%",tam:"$3.8M",comp:"–ù–∏–∑–∫–∞—è",mvp:"1.5 –Ω–µ–¥"},
];

// === INIT ===
document.addEventListener('DOMContentLoaded', () => {
  renderModes();
  renderNiches();
  loadStats();
  loadProjects();
  loadQuests();
});

// === VIEWS ===
function switchView(id, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
  document.getElementById('v-'+id).classList.add('on');
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  if(id === 'chat') {
    const msgs = document.getElementById('chatMessages');
    msgs.scrollTop = msgs.scrollHeight;
    document.getElementById('chatInput').focus();
  }
}

// === MODES ===
function renderModes() {
  const list = document.getElementById('modeList');
  list.innerHTML = '';
  for(const [key, m] of Object.entries(MODES)) {
    const div = document.createElement('div');
    div.className = 'mode-item' + (key === currentMode ? ' on' : '');
    div.innerHTML = `<div class="icon">${m.emoji}</div><div class="name">${m.name}</div>`;
    div.onclick = () => setMode(key);
    list.appendChild(div);
  }
}

function setMode(key) {
  currentMode = key;
  renderModes();
  fetch('/api/mode', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({session_id:SID, mode:key})
  });
  chatContext = [];
}

// === CHAT ===
function handleKey(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;

  input.value = '';
  addMsg('user', text);
  showTyping(true);
  document.getElementById('sendBtn').disabled = true;

  try {
    const resp = await fetch('/api/send', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({session_id:SID, text:text})
    });
    const data = await resp.json();
    showTyping(false);
    if(data.answer) {
      addMsg('bot', data.answer, data.time);
    } else {
      addMsg('bot', '–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
    }
  } catch(e) {
    showTyping(false);
    addMsg('bot', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
  }
  document.getElementById('sendBtn').disabled = false;
  loadStats();
}

function addMsg(role, text, time) {
  const msgs = document.getElementById('chatMessages');
  const isUser = role === 'user';
  const now = time || new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

  const div = document.createElement('div');
  div.className = 'msg' + (isUser ? ' user' : '');
  div.innerHTML = `
    <div class="avatar ${isUser ? 'user' : 'bot'}">${isUser ? 'üë§' : 'J'}</div>
    <div class="body">
      <div class="sender ${isUser ? 'u' : 'b'}">${isUser ? '–í—ã' : 'JARVIS 2.0'}</div>
      <div class="bubble">${escapeHtml(text)}</div>
      <div class="time">${now}</div>
    </div>
  `;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping(show) {
  document.getElementById('typing').classList.toggle('on', show);
}

function escapeHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

// === STATS ===
async function loadStats() {
  try {
    const resp = await fetch('/api/stats');
    const data = await resp.json();
    const p = data.player || {};

    document.getElementById('playerRank').textContent = `‚ö° –£—Ä.${p.level||1} ‚Äî ${p.rank||'–ù–æ–≤–∏—á–æ–∫'}`;
    document.getElementById('playerXP').textContent = `${p.xp||0}/${p.xp_to_next||1000} XP`;
    const pct = p.xp_to_next ? Math.round((p.xp/p.xp_to_next)*100) : 0;
    document.getElementById('xpFill').style.width = pct+'%';

    document.getElementById('statProj').textContent = data.total_projects || 0;
    document.getElementById('statQuest').textContent = data.active_quests || 0;
    document.getElementById('statStreak').textContent = p.streak || 0;

    document.getElementById('dashProj').textContent = data.active_projects || 0;
    document.getElementById('dashQuest').textContent = data.active_quests || 0;
    document.getElementById('dashMRR').textContent = '$' + (data.total_revenue || 0);
    document.getElementById('dashXP').textContent = p.xp || 0;
  } catch(e) {
    console.log('Stats error:', e);
  }
}

// === PROJECTS ===
async function loadProjects() {
  try {
    const resp = await fetch('/api/projects');
    const data = await resp.json();
    const list = document.getElementById('projList');
    const projects = data.projects || [];

    document.getElementById('projCnt').textContent = projects.length;
    list.innerHTML = '';

    if(projects.length === 0) {
      list.innerHTML = '<div style="padding:8px;font-size:.65rem;color:var(--t3)">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>';
      return;
    }

    projects.forEach(p => {
      const div = document.createElement('div');
      div.className = 'proj-item';
      div.innerHTML = `
        <div class="dot" style="background:${p.status==='active'?'var(--green)':'var(--t3)'}"></div>
        <div class="pname">${p.name}</div>
        <div class="prev">$${p.revenue||0}</div>
      `;
      list.appendChild(div);
    });
  } catch(e) {
    console.log('Projects error:', e);
  }
}

function openNewProject() {
  document.getElementById('modalNewProject').classList.add('on');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('on');
}

async function createProject() {
  const name = document.getElementById('npName').value.trim();
  const desc = document.getElementById('npDesc').value.trim();
  const mon = document.getElementById('npMon').value.trim();

  if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

  try {
    await fetch('/api/projects', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name, description:desc, monetization:mon})
    });
    closeModal('modalNewProject');
    document.getElementById('npName').value = '';
    document.getElementById('npDesc').value = '';
    document.getElementById('npMon').value = '';
    loadProjects();
    loadStats();
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞');
  }
}

// === QUESTS ===
async function loadQuests() {
  try {
    const resp = await fetch('/api/quests');
    const data = await resp.json();
    const list = document.getElementById('questList');
    const quests = data.quests || [];

    if(quests.length === 0) {
      list.innerHTML = `
        <div class="quest-card">
          <div class="quest-name">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤</div>
          <div style="font-size:.65rem;color:var(--t3)">–°–æ–∑–¥–∞–≤–∞–π –ø—Ä–æ–µ–∫—Ç—ã —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –∫–≤–µ—Å—Ç—ã</div>
        </div>`;
      return;
    }

    list.innerHTML = '';
    quests.filter(q => !q.completed).slice(0,5).forEach(q => {
      const tasks = q.tasks || [];
      const done = tasks.filter(t => t.done).length;
      const total = tasks.length || 1;
      const pct = Math.round((done/total)*100);
      const pClass = q.priority === 'urgent' ? 'urgent' : 'normal';

      let tasksHtml = '';
      tasks.forEach((t,i) => {
        tasksHtml += `
          <div class="quest-task ${t.done?'done':''}" onclick="toggleTask('${q.id}',${i})">
            <div class="check">${t.done?'‚úì':''}</div>
            <span class="task-text">${t.text||t}</span>
          </div>`;
      });

      const div = document.createElement('div');
      div.className = 'quest-card';
      div.innerHTML = `
        <div class="quest-top">
          <span class="quest-priority ${pClass}">${q.priority==='urgent'?'üî• –°—Ä–æ—á–Ω–æ':'üìã –û–±—ã—á–Ω—ã–π'}</span>
          <span class="quest-xp">+${q.xp_reward||100} XP</span>
        </div>
        <div class="quest-name">${q.name}</div>
        ${tasksHtml}
        <div class="quest-progress">
          <div class="quest-bar"><div class="quest-fill" style="width:${pct}%"></div></div>
          <span class="quest-pct">${done}/${total}</span>
        </div>
      `;
      list.appendChild(div);
    });
  } catch(e) {
    console.log('Quests error:', e);
  }
}

async function toggleTask(questId, taskIdx) {
  try {
    const resp = await fetch('/api/quests');
    const data = await resp.json();
    const quest = (data.quests||[]).find(q => q.id === questId);
    if(!quest) return;

    quest.tasks[taskIdx].done = !quest.tasks[taskIdx].done;
    const allDone = quest.tasks.every(t => t.done);

    await fetch('/api/quests/'+questId, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({tasks:quest.tasks, completed:allDone})
    });
    loadQuests();
    loadStats();
  } catch(e) {
    console.log('Toggle error:', e);
  }
}

// === NICHES ===
function renderNiches() {
  const grid = document.getElementById('nicheGrid');
  grid.innerHTML = '';
  NICHES.forEach(n => {
    const div = document.createElement('div');
    div.className = 'niche-card';
    div.onclick = () => analyzeNiche(n.title);
    div.innerHTML = `
      <div class="nc-top">
        <span style="font-size:.6rem;color:var(--t3)">üîç –ò–¥–µ—è</span>
        <span class="nc-score">${n.score}</span>
      </div>
      <div class="nc-title">${n.title}</div>
      <div class="nc-desc">${n.desc}</div>
      <div class="nc-metrics">
        <div class="nc-m"><div class="nc-mv">${n.tam}</div><div class="nc-ml">TAM</div></div>
        <div class="nc-m"><div class="nc-mv">${n.comp}</div><div class="nc-ml">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è</div></div>
        <div class="nc-m"><div class="nc-mv">${n.mvp}</div><div class="nc-ml">MVP</div></div>
      </div>
    `;
    grid.appendChild(div);
  });
}

async function analyzeNiche(niche) {
  document.getElementById('modalNiche').classList.add('on');
  document.getElementById('nicheResult').textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –Ω–∏—à—É: ' + niche + '...\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥...';

  try {
    const resp = await fetch('/api/analyze-niche', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({niche:niche, description:''})
    });
    const data = await resp.json();
    document.getElementById('nicheResult').textContent = data.analysis || data.error || '–û—à–∏–±–∫–∞';
  } catch(e) {
    document.getElementById('nicheResult').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
}
</script>
</body>
</html>
