<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JARVIS 2.0 ‚Äî Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg: #0a0a0f;
  --bg2: #12121a;
  --bg3: #1a1a2e;
  --bg4: #252540;
  --accent: #00d4ff;
  --accent2: #7c3aed;
  --green: #10b981;
  --red: #ef4444;
  --orange: #f59e0b;
  --yellow: #eab308;
  --pink: #ec4899;
  --text: #e2e8f0;
  --text2: #94a3b8;
  --text3: #64748b;
  --radius: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
body { background:var(--bg); color:var(--text); font-family:'Segoe UI',system-ui,sans-serif; min-height:100vh; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--bg2); }
::-webkit-scrollbar-thumb { background:var(--bg4); border-radius:3px; }

/* === LAYOUT === */
.app { display:flex; height:100vh; }
.sidebar { width:280px; background:var(--bg2); border-right:1px solid var(--bg3); display:flex; flex-direction:column; overflow-y:auto; flex-shrink:0; }
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.topbar { padding:12px 20px; background:var(--bg2); border-bottom:1px solid var(--bg3); display:flex; align-items:center; gap:12px; flex-shrink:0; }

/* === SIDEBAR === */
.logo { padding:20px; text-align:center; border-bottom:1px solid var(--bg3); }
.logo h1 { font-size:20px; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo small { color:var(--text3); font-size:11px; }

.player-card { padding:16px; border-bottom:1px solid var(--bg3); }
.player-level { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.player-level .lvl { font-size:18px; font-weight:700; color:var(--accent); }
.player-level .rank { font-size:12px; color:var(--text2); }
.xp-bar { height:8px; background:var(--bg4); border-radius:4px; overflow:hidden; margin-bottom:6px; }
.xp-bar-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:4px; transition:width .5s; }
.xp-text { font-size:11px; color:var(--text3); display:flex; justify-content:space-between; }
.streak-row { display:flex; align-items:center; gap:6px; margin-top:8px; font-size:13px; }
.streak-row .fire { font-size:16px; }

.nav-section { padding:12px; }
.nav-section h3 { font-size:11px; text-transform:uppercase; color:var(--text3); margin-bottom:8px; letter-spacing:1px; }
.nav-btn { width:100%; padding:10px 12px; background:none; border:none; color:var(--text2); cursor:pointer; text-align:left; border-radius:8px; font-size:13px; display:flex; align-items:center; gap:8px; transition:all .2s; margin-bottom:2px; }
.nav-btn:hover { background:var(--bg3); color:var(--text); }
.nav-btn.active { background:var(--bg3); color:var(--accent); }
.nav-btn .badge { margin-left:auto; background:var(--accent); color:var(--bg); font-size:10px; padding:2px 6px; border-radius:10px; font-weight:700; }

.project-item { padding:10px 12px; cursor:pointer; border-radius:8px; margin-bottom:2px; display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text2); transition:all .2s; }
.project-item:hover { background:var(--bg3); color:var(--text); }
.project-item .dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.project-item .stage-dot { }
.dot-idea { background:var(--text3); }
.dot-validation { background:var(--orange); }
.dot-mvp { background:var(--accent); }
.dot-launch { background:var(--green); }
.dot-growth { background:var(--pink); }

/* === MAIN CONTENT === */
.content { flex:1; overflow-y:auto; padding:20px; }

/* === TABS === */
.tabs { display:flex; gap:4px; }
.tab { padding:8px 16px; background:none; border:none; color:var(--text3); cursor:pointer; border-radius:8px 8px 0 0; font-size:13px; transition:all .2s; }
.tab:hover { color:var(--text); }
.tab.active { background:var(--bg3); color:var(--accent); }

/* === CARDS === */
.card { background:var(--bg2); border:1px solid var(--bg3); border-radius:var(--radius); padding:20px; margin-bottom:16px; }
.card h2 { font-size:16px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.card h3 { font-size:14px; margin-bottom:8px; color:var(--text2); }

/* === STATS GRID === */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-bottom:20px; }
.stat-card { background:var(--bg2); border:1px solid var(--bg3); border-radius:var(--radius); padding:16px; text-align:center; }
.stat-card .num { font-size:28px; font-weight:700; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.stat-card .label { font-size:11px; color:var(--text3); margin-top:4px; text-transform:uppercase; }

/* === FUNNEL === */
.funnel { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
.funnel-stage { flex:1; min-width:120px; background:var(--bg2); border:1px solid var(--bg3); border-radius:var(--radius); padding:12px; text-align:center; cursor:pointer; transition:all .2s; position:relative; }
.funnel-stage:hover { border-color:var(--accent); }
.funnel-stage .stage-icon { font-size:24px; }
.funnel-stage .stage-name { font-size:11px; color:var(--text2); margin-top:4px; }
.funnel-stage .stage-count { font-size:20px; font-weight:700; color:var(--accent); margin-top:4px; }
.funnel-arrow { display:flex; align-items:center; color:var(--text3); font-size:18px; }

/* === CHAT === */
.chat-container { display:flex; flex-direction:column; height:100%; }
.chat-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
.chat-input-row { padding:16px 20px; background:var(--bg2); border-top:1px solid var(--bg3); display:flex; gap:8px; }
.chat-input-row input { flex:1; padding:12px 16px; background:var(--bg3); border:1px solid var(--bg4); border-radius:var(--radius); color:var(--text); font-size:14px; outline:none; }
.chat-input-row input:focus { border-color:var(--accent); }

.msg { max-width:80%; padding:12px 16px; border-radius:var(--radius); font-size:14px; line-height:1.6; white-space:pre-wrap; word-break:break-word; }
.msg.user { background:var(--accent2); align-self:flex-end; border-bottom-right-radius:4px; }
.msg.bot { background:var(--bg3); align-self:flex-start; border-bottom-left-radius:4px; }
.msg .time { font-size:10px; color:var(--text3); margin-top:4px; }

/* === BUTTONS === */
.btn { padding:10px 18px; border:none; border-radius:var(--radius); cursor:pointer; font-size:13px; font-weight:600; transition:all .2s; display:inline-flex; align-items:center; gap:6px; }
.btn-primary { background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; }
.btn-primary:hover { opacity:.9; transform:translateY(-1px); }
.btn-secondary { background:var(--bg3); color:var(--text); border:1px solid var(--bg4); }
.btn-secondary:hover { border-color:var(--accent); }
.btn-danger { background:var(--red); color:white; }
.btn-danger:hover { opacity:.9; }
.btn-success { background:var(--green); color:white; }
.btn-success:hover { opacity:.9; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-icon { width:36px; height:36px; padding:0; display:flex; align-items:center; justify-content:center; }

/* === FORMS === */
.form-group { margin-bottom:12px; }
.form-group label { display:block; font-size:12px; color:var(--text2); margin-bottom:4px; }
.form-group input, .form-group textarea, .form-group select {
  width:100%; padding:10px 12px; background:var(--bg3); border:1px solid var(--bg4);
  border-radius:8px; color:var(--text); font-size:14px; outline:none; font-family:inherit;
}
.form-group input:focus, .form-group textarea:focus { border-color:var(--accent); }
.form-group textarea { resize:vertical; min-height:80px; }

/* === MODE SELECTOR === */
.mode-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:8px; }
.mode-btn { padding:12px; background:var(--bg3); border:2px solid transparent; border-radius:var(--radius); cursor:pointer; text-align:center; transition:all .2s; }
.mode-btn:hover { border-color:var(--accent); }
.mode-btn.active { border-color:var(--accent); background:rgba(0,212,255,0.1); }
.mode-btn .mode-emoji { font-size:24px; display:block; margin-bottom:4px; }
.mode-btn .mode-name { font-size:11px; color:var(--text2); }

/* === QUEST === */
.quest-item { background:var(--bg3); border-radius:var(--radius); padding:14px; margin-bottom:8px; }
.quest-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.quest-name { font-size:14px; font-weight:600; }
.quest-xp { font-size:12px; color:var(--accent); }
.quest-priority { font-size:10px; padding:2px 8px; border-radius:10px; }
.priority-urgent { background:rgba(239,68,68,0.2); color:var(--red); }
.priority-normal { background:rgba(16,185,129,0.2); color:var(--green); }
.quest-task { display:flex; align-items:center; gap:8px; padding:6px 0; cursor:pointer; font-size:13px; }
.quest-task input[type=checkbox] { accent-color:var(--accent); width:16px; height:16px; cursor:pointer; }
.quest-task.done { text-decoration:line-through; color:var(--text3); }
.quest-completed { opacity:0.5; }

/* === MISSION === */
.mission-card { background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(124,58,237,0.1)); border:1px solid var(--accent); }
.mission-timer { font-size:12px; color:var(--accent); margin-top:8px; }

/* === ACHIEVEMENTS === */
.ach-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:8px; }
.ach-item { text-align:center; padding:12px 8px; background:var(--bg3); border-radius:var(--radius); transition:all .2s; }
.ach-item.locked { opacity:0.3; filter:grayscale(1); }
.ach-item .ach-icon { font-size:28px; display:block; margin-bottom:4px; }
.ach-item .ach-name { font-size:10px; color:var(--text2); }

/* === CHARTS === */
.chart-container { position:relative; height:250px; margin-bottom:16px; }

/* === TOAST === */
.toast-container { position:fixed; top:20px; right:20px; z-index:10000; display:flex; flex-direction:column; gap:8px; }
.toast { padding:14px 20px; border-radius:var(--radius); color:white; font-size:13px; font-weight:600; animation:slideIn .3s ease, fadeOut .3s ease 3s forwards; box-shadow:var(--shadow); display:flex; align-items:center; gap:8px; max-width:350px; }
.toast-success { background:var(--green); }
.toast-error { background:var(--red); }
.toast-info { background:var(--accent); color:var(--bg); }
.toast-achievement { background:linear-gradient(135deg,var(--orange),var(--pink)); }
.toast-levelup { background:linear-gradient(135deg,var(--accent),var(--accent2)); }
@keyframes slideIn { from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1} }
@keyframes fadeOut { to{opacity:0;transform:translateY(-20px)} }

/* === MODAL === */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9000; display:flex; align-items:center; justify-content:center; }
.modal { background:var(--bg2); border:1px solid var(--bg3); border-radius:var(--radius); padding:24px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; }
.modal h2 { margin-bottom:16px; font-size:18px; }
.modal-actions { display:flex; gap:8px; margin-top:16px; justify-content:flex-end; }

/* === RESEARCH RESULTS === */
.reddit-post { background:var(--bg3); border-radius:8px; padding:12px; margin-bottom:8px; }
.reddit-post .post-title { font-size:13px; font-weight:600; color:var(--accent); }
.reddit-post .post-meta { font-size:11px; color:var(--text3); margin-top:4px; }
.reddit-post .post-text { font-size:12px; color:var(--text2); margin-top:6px; }

/* === PROJECT DETAIL === */
.project-stage-bar { display:flex; gap:4px; margin-bottom:16px; }
.stage-step { flex:1; padding:8px; text-align:center; border-radius:8px; font-size:11px; cursor:pointer; transition:all .2s; background:var(--bg4); color:var(--text3); }
.stage-step.current { background:var(--accent); color:var(--bg); font-weight:700; }
.stage-step.passed { background:rgba(16,185,129,0.3); color:var(--green); }
.stage-step:hover { opacity:.8; }

.link-item { display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg3); border-radius:8px; margin-bottom:6px; font-size:13px; }
.link-item a { color:var(--accent); text-decoration:none; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.link-item a:hover { text-decoration:underline; }

.note-item { padding:10px; background:var(--bg3); border-radius:8px; margin-bottom:6px; font-size:13px; }
.note-item .note-date { font-size:10px; color:var(--text3); margin-top:4px; }

/* === HAMBURGER === */
.hamburger { display:none; background:none; border:none; color:var(--text); font-size:24px; cursor:pointer; }

/* === MOBILE === */
@media(max-width:768px) {
  .sidebar { position:fixed; left:-280px; top:0; bottom:0; z-index:8000; transition:left .3s; }
  .sidebar.open { left:0; }
  .hamburger { display:block; }
  .stats-grid { grid-template-columns:repeat(2,1fr); }
  .funnel { flex-direction:column; }
  .funnel-arrow { display:none; }
  .mode-grid { grid-template-columns:repeat(3,1fr); }
  .ach-grid { grid-template-columns:repeat(4,1fr); }
  .msg { max-width:95%; }
  .chart-container { height:200px; }
  .modal { width:95%; }
}
</style>
</head>
<body>

<div class="toast-container" id="toasts"></div>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <h1>ü§ñ JARVIS 2.0</h1>
      <small>AI Command Center</small>
    </div>

    <div class="player-card" id="playerCard">
      <div class="player-level">
        <span class="lvl">Lv.1</span>
        <span class="rank">–ù–æ–≤–∏—á–æ–∫</span>
      </div>
      <div class="xp-bar"><div class="xp-bar-fill" style="width:0%"></div></div>
      <div class="xp-text"><span>0 XP</span><span>/ 1000</span></div>
      <div class="streak-row"><span class="fire">üî•</span><span>0 –¥–Ω–µ–π</span></div>
    </div>

    <div class="nav-section">
      <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
      <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
      <button class="nav-btn" onclick="showPage('chat')">üí¨ AI –ß–∞—Ç</button>
      <button class="nav-btn" onclick="showPage('projects')">üöÄ –ü—Ä–æ–µ–∫—Ç—ã</button>
      <button class="nav-btn" onclick="showPage('quests')">‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</button>
      <button class="nav-btn" onclick="showPage('research')">üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</button>
      <button class="nav-btn" onclick="showPage('achievements')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button class="nav-btn" onclick="showPage('funnel')">üìà –í–æ—Ä–æ–Ω–∫–∞</button>
      <button class="nav-btn" onclick="showPage('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="nav-section">
      <h3>–ü—Ä–æ–µ–∫—Ç—ã</h3>
      <div id="sidebarProjects"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <span id="pageTitle" style="font-weight:700;font-size:16px;">üìä Dashboard</span>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="btn btn-sm btn-secondary" onclick="loadAll()">üîÑ</button>
      </div>
    </div>

    <div class="content" id="content"></div>
  </div>
</div>

<script>
// === STATE ===
const SID = localStorage.getItem('jarvis_sid') || (() => { const s = 'sid_'+Math.random().toString(36).slice(2); localStorage.setItem('jarvis_sid',s); return s; })();
let STATE = {
  player: {},
  stats: {},
  projects: [],
  quests: [],
  achievements: [],
  mission: {},
  history: [],
  modes: {},
  currentPage: 'dashboard',
  currentProject: null,
  chatMessages: JSON.parse(localStorage.getItem('jarvis_chat')||'[]'),
  currentMode: 'helper'
};

// === TOAST ===
function toast(text, type='info') {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = text;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// === API ===
async function api(url, method='GET', body=null) {
  try {
    const opts = { method, headers: {'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    return await r.json();
  } catch(e) {
    toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    return null;
  }
}

// === LOAD ALL DATA ===
async function loadAll() {
  const [stats, projects, quests, achievements, mission, history, modes] = await Promise.all([
    api('/api/stats'),
    api('/api/projects'),
    api('/api/quests'),
    api('/api/achievements'),
    api('/api/mission'),
    api('/api/history'),
    api('/api/modes')
  ]);
  if(stats) STATE.stats = stats;
  if(stats?.player) STATE.player = stats.player;
  if(projects?.projects) STATE.projects = projects.projects;
  if(quests?.quests) STATE.quests = quests.quests;
  if(achievements) STATE.achievements = achievements;
  if(mission) STATE.mission = mission;
  if(history?.entries) STATE.history = history.entries;
  if(modes) STATE.modes = modes;
  updatePlayerCard();
  updateSidebarProjects();
  renderPage();
}

// === PLAYER CARD ===
function updatePlayerCard() {
  const p = STATE.player;
  if (!p.level) return;
  const card = document.getElementById('playerCard');
  const pct = p.xp_to_next > 0 ? (p.xp / p.xp_to_next * 100) : 0;
  card.innerHTML = `
    <div class="player-level">
      <span class="lvl">Lv.${p.level}</span>
      <span class="rank">${p.rank||'–ù–æ–≤–∏—á–æ–∫'}</span>
    </div>
    <div class="xp-bar"><div class="xp-bar-fill" style="width:${pct}%"></div></div>
    <div class="xp-text"><span>${p.xp||0} XP</span><span>/ ${p.xp_to_next||1000}</span></div>
    <div class="streak-row"><span class="fire">üî•</span><span>${p.streak||0} –¥–Ω–µ–π</span>
    ${p.max_streak > 0 ? `<span style="color:var(--text3);font-size:11px;">(—Ä–µ–∫–æ—Ä–¥: ${p.max_streak})</span>` : ''}</div>
  `;
}

// === SIDEBAR PROJECTS ===
function updateSidebarProjects() {
  const c = document.getElementById('sidebarProjects');
  const active = STATE.projects.filter(p => p.status !== 'archived');
  c.innerHTML = active.map(p => `
    <div class="project-item" onclick="openProject('${p.id}')">
      <span class="dot dot-${p.stage||'idea'}"></span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
      ${p.revenue > 0 ? `<span style="color:var(--green);font-size:11px;">$${p.revenue}</span>` : ''}
    </div>
  `).join('') || '<div style="padding:12px;color:var(--text3);font-size:12px;">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</div>';
}

// === PAGES ===
function showPage(page) {
  STATE.currentPage = page;
  STATE.currentProject = null;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const titles = {dashboard:'üìä Dashboard',chat:'üí¨ AI –ß–∞—Ç',projects:'üöÄ –ü—Ä–æ–µ–∫—Ç—ã',quests:'‚öîÔ∏è –ö–≤–µ—Å—Ç—ã',research:'üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è',achievements:'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',funnel:'üìà –í–æ—Ä–æ–Ω–∫–∞',settings:'‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'};
  document.getElementById('pageTitle').textContent = titles[page]||page;
  event?.target?.classList?.add('active');
  closeSidebar();
  renderPage();
}

function renderPage() {
  const c = document.getElementById('content');
  const pages = {dashboard:renderDashboard,chat:renderChat,projects:renderProjects,quests:renderQuests,research:renderResearch,achievements:renderAchievements,funnel:renderFunnel,settings:renderSettings,projectDetail:renderProjectDetail};
  const fn = pages[STATE.currentPage];
  if(fn) c.innerHTML = fn();
  afterRender();
}

// === AFTER RENDER (bindings) ===
function afterRender() {
  if(STATE.currentPage === 'chat') initChat();
  if(STATE.currentPage === 'dashboard') initCharts();
}

// === DASHBOARD ===
function renderDashboard() {
  const s = STATE.stats;
  const p = STATE.player;
  const m = STATE.mission;
  const f = s.funnel || {};
  return `
    <div class="stats-grid">
      <div class="stat-card"><div class="num">${s.active_projects||0}</div><div class="label">–ü—Ä–æ–µ–∫—Ç—ã</div></div>
      <div class="stat-card"><div class="num">$${s.total_revenue||0}</div><div class="label">–î–æ—Ö–æ–¥</div></div>
      <div class="stat-card"><div class="num">${s.completed_quests||0}</div><div class="label">–ö–≤–µ—Å—Ç—ã</div></div>
      <div class="stat-card"><div class="num">${p.total_xp||0}</div><div class="label">–í—Å–µ–≥–æ XP</div></div>
      <div class="stat-card"><div class="num">${s.total_messages||0}</div><div class="label">–°–æ–æ–±—â–µ–Ω–∏—è</div></div>
      <div class="stat-card"><div class="num">${s.niches_analyzed||0}</div><div class="label">–ù–∏—à</div></div>
    </div>

    ${m.name ? `
    <div class="card mission-card">
      <h2>üéØ –ú–∏—Å—Å–∏—è –Ω–µ–¥–µ–ª–∏: ${m.name}</h2>
      ${(m.tasks||[]).map((t,i) => `
        <div class="quest-task ${t.done?'done':''}" onclick="toggleMission(${i})">
          <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();toggleMission(${i})">
          <span>${t.text}</span>
        </div>
      `).join('')}
      <div class="mission-timer">‚è∞ –î–æ ${m.week_end||'...'} | üéÅ +${m.xp_reward||500} XP</div>
    </div>
    ` : ''}

    <div class="card">
      <h2>üìà –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</h2>
      <div class="funnel">
        ${Object.entries(f).map(([k,v]) => `
          <div class="funnel-stage" onclick="showPage('funnel')">
            <div class="stage-icon">${{'idea':'üí°','validation':'üîç','mvp':'üõ†','launch':'üöÄ','growth':'üìà'}[k]||'üì¶'}</div>
            <div class="stage-name">${v.name||k}</div>
            <div class="stage-count">${v.count||0}</div>
          </div>
          ${k!=='growth'?'<div class="funnel-arrow">‚Üí</div>':''}
        `).join('')}
      </div>
    </div>

    <div class="card">
      <h2>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
      <div class="chart-container"><canvas id="chartXP"></canvas></div>
    </div>
    <div class="card">
      <h2>üí∞ –î–æ—Ö–æ–¥</h2>
      <div class="chart-container"><canvas id="chartRevenue"></canvas></div>
    </div>
  `;
}

function initCharts() {
  const entries = STATE.history || [];
  if (entries.length < 1) return;
  const labels = entries.map(e => e.date?.slice(5)||'');
  const xpData = entries.map(e => e.xp||0);
  const revData = entries.map(e => e.revenue||0);

  const xpEl = document.getElementById('chartXP');
  const revEl = document.getElementById('chartRevenue');
  if(xpEl) new Chart(xpEl, {type:'line',data:{labels,datasets:[{label:'XP',data:xpData,borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,0.1)',fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b'}}}}});
  if(revEl) new Chart(revEl, {type:'bar',data:{labels,datasets:[{label:'–î–æ—Ö–æ–¥ $',data:revData,backgroundColor:'rgba(16,185,129,0.6)',borderColor:'#10b981',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'}},y:{ticks:{color:'#64748b'}}}}});
}

// === CHAT ===
function renderChat() {
  const modeKeys = Object.keys(STATE.modes);
  return `
    <div class="mode-grid" style="margin-bottom:16px;">
      ${modeKeys.map(k => {
        const m = STATE.modes[k];
        return `<div class="mode-btn ${STATE.currentMode===k?'active':''}" onclick="setMode('${k}')">
          <span class="mode-emoji">${m.emoji}</span>
          <span class="mode-name">${m.name}</span>
        </div>`;
      }).join('')}
    </div>
    <div class="chat-container" style="height:calc(100vh - 280px);">
      <div class="chat-messages" id="chatMessages">
        ${STATE.chatMessages.map(m => `<div class="msg ${m.role}">${m.text}<div class="time">${m.time||''}</div></div>`).join('')}
      </div>
      <div class="chat-input-row">
        <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary" onclick="sendChat()">‚û§</button>
        <button class="btn btn-secondary btn-icon" onclick="clearChat()" title="–û—á–∏—Å—Ç–∏—Ç—å">üóë</button>
      </div>
    </div>
  `;
}

function initChat() {
  const msgs = document.getElementById('chatMessages');
  if(msgs) msgs.scrollTop = msgs.scrollHeight;
  document.getElementById('chatInput')?.focus();
}

async function setMode(mode) {
  STATE.currentMode = mode;
  await api('/api/mode','POST',{session_id:SID,mode});
  toast(`–†–µ–∂–∏–º: ${STATE.modes[mode]?.name||mode}`, 'info');
  renderPage();
}

async function sendChat() {
  const inp = document.getElementById('chatInput');
  const text = inp.value.trim();
  if(!text) return;
  inp.value = '';
  const time = new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
  STATE.chatMessages.push({role:'user',text,time});
  renderPage();

  const r = await api('/api/send','POST',{session_id:SID,text});
  if(r?.answer) {
    STATE.chatMessages.push({role:'bot',text:r.answer,time:r.time||time});
    localStorage.setItem('jarvis_chat',JSON.stringify(STATE.chatMessages.slice(-50)));
    // Check for achievements/levelup
    const stats = await api('/api/stats');
    if(stats?.player) {
      const oldLvl = STATE.player.level||1;
      STATE.player = stats.player;
      STATE.stats = stats;
      updatePlayerCard();
      if(stats.player.level > oldLvl) toast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${stats.player.level}!`, 'levelup');
    }
  }
  renderPage();
}

function clearChat() {
  STATE.chatMessages = [];
  localStorage.removeItem('jarvis_chat');
  api('/api/clear','POST',{session_id:SID});
  renderPage();
}

// === PROJECTS ===
function renderProjects() {
  const active = STATE.projects.filter(p => p.status !== 'archived');
  const archived = STATE.projects.filter(p => p.status === 'archived');
  return `
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="btn btn-primary" onclick="showCreateProject()">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
    </div>

    ${active.length ? active.map(p => `
      <div class="card" style="cursor:pointer;" onclick="openProject('${p.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <span class="dot dot-${p.stage||'idea'}" style="display:inline-block;margin-right:8px;"></span>
            <strong>${p.name}</strong>
            <span style="color:var(--text3);font-size:12px;margin-left:8px;">${{'idea':'üí° –ò–¥–µ—è','validation':'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è','mvp':'üõ† MVP','launch':'üöÄ –ó–∞–ø—É—Å–∫','growth':'üìà –†–æ—Å—Ç'}[p.stage||'idea']}</span>
          </div>
          <div style="display:flex;gap:12px;align-items:center;">
            ${p.revenue > 0 ? `<span style="color:var(--green);font-weight:700;">$${p.revenue}</span>` : ''}
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();archiveProject('${p.id}')">üì¶</button>
          </div>
        </div>
        ${p.description ? `<div style="color:var(--text2);font-size:13px;margin-top:8px;">${p.description.slice(0,100)}</div>` : ''}
      </div>
    `).join('') : '<div class="card"><p style="color:var(--text3);">–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!</p></div>'}

    ${archived.length ? `
      <h3 style="color:var(--text3);margin:20px 0 10px;">üì¶ –ê—Ä—Ö–∏–≤ (${archived.length})</h3>
      ${archived.map(p => `
        <div class="card" style="opacity:0.5;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>${p.name}</strong>
            <button class="btn btn-sm btn-secondary" onclick="restoreProject('${p.id}')">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
      `).join('')}
    ` : ''}
  `;
}

function showCreateProject() {
  showModal('–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç', `
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="pName" placeholder="–ú–æ–π –∫—Ä—É—Ç–æ–π –ø—Ä–æ–µ–∫—Ç"></div>
    <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="pDesc" placeholder="–ß—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–æ–µ–∫—Ç?"></textarea></div>
    <div class="form-group"><label>–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</label><input id="pMon" placeholder="–ü–æ–¥–ø–∏—Å–∫–∏, —Ä–µ–∫–ª–∞–º–∞..."></div>
  `, async () => {
    const r = await api('/api/projects','POST',{
      name: document.getElementById('pName').value,
      description: document.getElementById('pDesc').value,
      monetization: document.getElementById('pMon').value
    });
    if(r?.id) {
      toast('üöÄ –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω! –ö–≤–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è...','success');
      closeModal();
      await loadAll();
    }
  });
}

async function archiveProject(id) {
  await api(`/api/projects/${id}`,'DELETE');
  toast('üì¶ –ü—Ä–æ–µ–∫—Ç –≤ –∞—Ä—Ö–∏–≤–µ','info');
  await loadAll();
}

async function restoreProject(id) {
  await api(`/api/projects/${id}/restore`,'POST');
  toast('‚ôªÔ∏è –ü—Ä–æ–µ–∫—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω','success');
  await loadAll();
}

// === PROJECT DETAIL ===
function openProject(id) {
  STATE.currentProject = id;
  STATE.currentPage = 'projectDetail';
  renderPage();
}

function renderProjectDetail() {
  const p = STATE.projects.find(x => x.id === STATE.currentProject);
  if(!p) return '<div class="card">–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
  const quests = STATE.quests.filter(q => q.project_id === p.id);
  const stages = ['idea','validation','mvp','launch','growth'];
  const stageNames = {idea:'üí° –ò–¥–µ—è',validation:'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è',mvp:'üõ† MVP',launch:'üöÄ –ó–∞–ø—É—Å–∫',growth:'üìà –†–æ—Å—Ç'};
  const currentIdx = stages.indexOf(p.stage||'idea');

  return `
    <button class="btn btn-sm btn-secondary" onclick="showPage('projects')" style="margin-bottom:16px;">‚Üê –ù–∞–∑–∞–¥</button>

    <div class="card">
      <h2>${p.name}</h2>
      <p style="color:var(--text2);margin-bottom:12px;">${p.description||'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
      <p style="font-size:13px;color:var(--text3);">üí∞ –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è: ${p.monetization||'‚Äî'} | üíµ –î–æ—Ö–æ–¥: $${p.revenue||0}</p>

      <div class="project-stage-bar" style="margin-top:16px;">
        ${stages.map((s,i) => `
          <div class="stage-step ${i===currentIdx?'current':''} ${i<currentIdx?'passed':''}"
               onclick="changeStage('${p.id}','${s}')">
            ${stageNames[s]}
          </div>
        `).join('')}
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-sm btn-success" onclick="showAddRevenue('${p.id}')">üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
        <button class="btn btn-sm btn-secondary" onclick="showAddLink('${p.id}')">üîó –°—Å—ã–ª–∫–∞</button>
        <button class="btn btn-sm btn-secondary" onclick="showAddNote('${p.id}')">üìù –ó–∞–º–µ—Ç–∫–∞</button>
        <button class="btn btn-sm btn-secondary" onclick="generateOffer('${p.id}')">‚ú® –û—Ñ—Ñ–µ—Ä</button>
      </div>
    </div>

    ${quests.length ? `
    <div class="card">
      <h2>‚öîÔ∏è –ö–≤–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
      ${quests.map(q => renderQuestItem(q)).join('')}
    </div>
    ` : ''}

    ${(p.links||[]).length ? `
    <div class="card">
      <h2>üîó –°—Å—ã–ª–∫–∏</h2>
      ${p.links.map(l => `
        <div class="link-item">
          <a href="${l.url}" target="_blank">${l.title||l.url}</a>
          <button class="btn btn-sm btn-danger btn-icon" onclick="deleteLink('${p.id}','${l.id}')">‚úï</button>
        </div>
      `).join('')}
    </div>
    ` : ''}

    ${(p.notes||[]).length ? `
    <div class="card">
      <h2>üìù –ó–∞–º–µ—Ç–∫–∏</h2>
      ${p.notes.map(n => `
        <div class="note-item">
          ${n.text}
          <div class="note-date">${n.added?.slice(0,10)||''}</div>
        </div>
      `).join('')}
    </div>
    ` : ''}

    ${(p.revenue_history||[]).length ? `
    <div class="card">
      <h2>üíµ –ò—Å—Ç–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤</h2>
      ${p.revenue_history.map(r => `
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bg3);font-size:13px;">
          <span style="color:var(--green);">+$${r.amount}</span>
          <span style="color:var(--text3);">${r.note||''} ${r.date?.slice(0,10)||''}</span>
        </div>
      `).join('')}
    </div>
    ` : ''}
  `;
}

async function changeStage(pid, stage) {
  const r = await api(`/api/projects/${pid}/stage`,'PUT',{stage});
  if(r?.stage) {
    toast(`–°—Ç–∞–¥–∏—è: ${{idea:'üí° –ò–¥–µ—è',validation:'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è',mvp:'üõ† MVP',launch:'üöÄ –ó–∞–ø—É—Å–∫',growth:'üìà –†–æ—Å—Ç'}[stage]}`,'success');
    await loadAll();
    openProject(pid);
  }
}

function showAddRevenue(pid) {
  showModal('–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥', `
    <div class="form-group"><label>–°—É–º–º–∞ ($)</label><input id="revAmount" type="number" placeholder="100"></div>
    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><input id="revNote" placeholder="–û—Ç–∫—É–¥–∞ –¥–æ—Ö–æ–¥?"></div>
  `, async () => {
    await api(`/api/projects/${pid}/revenue`,'POST',{
      amount: parseFloat(document.getElementById('revAmount').value)||0,
      note: document.getElementById('revNote').value
    });
    toast('üí∞ –î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!','success');
    closeModal();
    await loadAll();
    openProject(pid);
  });
}

function showAddLink(pid) {
  showModal('–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É', `
    <div class="form-group"><label>URL</label><input id="linkUrl" placeholder="https://..."></div>
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="linkTitle" placeholder="–ú–æ–π —Å–∞–π—Ç"></div>
  `, async () => {
    await api(`/api/projects/${pid}/links`,'POST',{
      url: document.getElementById('linkUrl').value,
      title: document.getElementById('linkTitle').value
    });
    toast('üîó –°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!','success');
    closeModal();
    await loadAll();
    openProject(pid);
  });
}

function showAddNote(pid) {
  showModal('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É', `
    <div class="form-group"><label>–¢–µ–∫—Å—Ç</label><textarea id="noteText" placeholder="–ó–∞–º–µ—Ç–∫–∞..."></textarea></div>
  `, async () => {
    await api(`/api/projects/${pid}/notes`,'POST',{text: document.getElementById('noteText').value});
    toast('üìù –ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!','success');
    closeModal();
    await loadAll();
    openProject(pid);
  });
}

async function deleteLink(pid, lid) {
  await api(`/api/projects/${pid}/links/${lid}`,'DELETE');
  await loadAll();
  openProject(pid);
}

async function generateOffer(pid) {
  toast('‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ñ—Ñ–µ—Ä...','info');
  const r = await api(`/api/projects/${pid}/offer`,'POST');
  if(r?.offer) {
    showModal('‚ú® –û—Ñ—Ñ–µ—Ä', `<div style="white-space:pre-wrap;font-size:14px;line-height:1.6;">${r.offer}</div>`, null);
  }
}

// === QUESTS ===
function renderQuests() {
  const active = STATE.quests.filter(q => !q.completed);
  const done = STATE.quests.filter(q => q.completed);
  return `
    <div style="margin-bottom:16px;">
      <button class="btn btn-primary" onclick="showCreateQuest()">‚ûï –ù–æ–≤—ã–π –∫–≤–µ—Å—Ç</button>
    </div>

    ${active.length ? `<h3 style="margin-bottom:10px;">–ê–∫—Ç–∏–≤–Ω—ã–µ (${active.length})</h3>` : ''}
    ${active.map(q => renderQuestItem(q)).join('')}
    ${!active.length ? '<div class="card"><p style="color:var(--text3);">–í—Å–µ –∫–≤–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! üéâ</p></div>' : ''}

    ${done.length ? `
      <h3 style="color:var(--text3);margin:20px 0 10px;">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (${done.length})</h3>
      ${done.slice(-5).map(q => renderQuestItem(q)).join('')}
    ` : ''}
  `;
}

function renderQuestItem(q) {
  const projectName = STATE.projects.find(p => p.id === q.project_id)?.name || '';
  return `
    <div class="quest-item ${q.completed?'quest-completed':''}">
      <div class="quest-header">
        <div>
          <span class="quest-name">${q.name}</span>
          ${projectName ? `<span style="font-size:11px;color:var(--text3);margin-left:8px;">üìÇ ${projectName}</span>` : ''}
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="quest-priority priority-${q.priority||'normal'}">${q.priority==='urgent'?'üî¥ –°—Ä–æ—á–Ω–æ':'üü¢ –û–±—ã—á–Ω—ã–π'}</span>
          <span class="quest-xp">+${q.xp_reward||100} XP</span>
        </div>
      </div>
      ${(q.tasks||[]).map((t,i) => `
        <div class="quest-task ${t.done?'done':''}" onclick="toggleTask('${q.id}',${i})">
          <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();toggleTask('${q.id}',${i})">
          <span>${t.text}</span>
        </div>
      `).join('')}
    </div>
  `;
}

async function toggleTask(qid, idx) {
  const r = await api(`/api/quests/${qid}/toggle-task`,'POST',{index:idx});
  if(r?.completed && !STATE.quests.find(q=>q.id===qid)?.completed) {
    toast(`‚öîÔ∏è –ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! +${r.xp_reward||100} XP`,'achievement');
  }
  await loadAll();
}

function showCreateQuest() {
  const projectOpts = STATE.projects.filter(p=>p.status==='active').map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  showModal('–ù–æ–≤—ã–π –∫–≤–µ—Å—Ç', `
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="qName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–∞"></div>
    <div class="form-group"><label>–ü—Ä–æ–µ–∫—Ç</label><select id="qProject"><option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>${projectOpts}</select></div>
    <div class="form-group"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select id="qPriority"><option value="normal">–û–±—ã—á–Ω—ã–π</option><option value="urgent">–°—Ä–æ—á–Ω—ã–π</option></select></div>
    <div class="form-group"><label>–ó–∞–¥–∞—á–∏ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label><textarea id="qTasks" placeholder="–ó–∞–¥–∞—á–∞ 1\n–ó–∞–¥–∞—á–∞ 2\n–ó–∞–¥–∞—á–∞ 3"></textarea></div>
  `, async () => {
    const tasks = document.getElementById('qTasks').value.split('\n').filter(t=>t.trim());
    await api('/api/quests','POST',{
      name: document.getElementById('qName').value,
      project_id: document.getElementById('qProject').value,
      priority: document.getElementById('qPriority').value,
      tasks,
      xp_reward: document.getElementById('qPriority').value==='urgent' ? 250 : 150
    });
    toast('‚öîÔ∏è –ö–≤–µ—Å—Ç —Å–æ–∑–¥–∞–Ω!','success');
    closeModal();
    await loadAll();
  });
}

// === MISSION ===
async function toggleMission(idx) {
  const r = await api('/api/mission/toggle','POST',{index:idx});
  if(r) {
    STATE.mission = r;
    if(r.completed) toast('üéØ –ú–∏—Å—Å–∏—è –Ω–µ–¥–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +500 XP','achievement');
    await loadAll();
  }
}

// === RESEARCH ===
function renderResearch() {
  return `
    <div class="card">
      <h2>üîç –ê–Ω–∞–ª–∏–∑ –Ω–∏—à–∏</h2>
      <div class="form-group"><input id="nicheInput" placeholder="–í–≤–µ–¥–∏ –Ω–∏—à—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" onclick="analyzeNiche()">üìä –ê–Ω–∞–ª–∏–∑</button>
        <button class="btn btn-secondary" onclick="scoreIdea()">üìà –°–∫–æ—Ä–∏–Ω–≥</button>
      </div>
      <div id="nicheResult" style="margin-top:16px;"></div>
    </div>

    <div class="card">
      <h2>üîé Reddit ‚Äî –ø–æ–∏—Å–∫ –±–æ–ª–µ–π</h2>
      <div class="form-group"><input id="redditInput" placeholder="–ß—Ç–æ –∏—â–µ–º –Ω–∞ Reddit?"></div>
      <button class="btn btn-primary" onclick="searchReddit()">üîé –ù–∞–π—Ç–∏ –±–æ–ª–∏</button>
      <div id="redditResult" style="margin-top:16px;"></div>
    </div>

    <div class="card">
      <h2>üìà –¢—Ä–µ–Ω–¥—ã</h2>
      <div class="form-group"><input id="trendInput" placeholder="–¢–µ–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤..."></div>
      <button class="btn btn-primary" onclick="searchTrends()">üìà –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤</button>
      <div id="trendResult" style="margin-top:16px;"></div>
    </div>
  `;
}

async function analyzeNiche() {
  const niche = document.getElementById('nicheInput').value;
  if(!niche) return;
  document.getElementById('nicheResult').innerHTML = '<p style="color:var(--accent);">‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</p>';
  const r = await api('/api/analyze-niche','POST',{niche});
  document.getElementById('nicheResult').innerHTML = r?.analysis ?
    `<div style="white-space:pre-wrap;line-height:1.6;font-size:14px;">${r.analysis}</div>` :
    '<p style="color:var(--red);">–û—à–∏–±–∫–∞</p>';
  await loadAll();
}

async function scoreIdea() {
  const idea = document.getElementById('nicheInput').value;
  if(!idea) return;
  document.getElementById('nicheResult').innerHTML = '<p style="color:var(--accent);">‚è≥ –û—Ü–µ–Ω–∏–≤–∞—é...</p>';
  const r = await api('/api/score-idea','POST',{idea});
  if(r && r.total !== undefined) {
    const color = r.total >= 70 ? 'var(--green)' : r.total >= 40 ? 'var(--orange)' : 'var(--red)';
    document.getElementById('nicheResult').innerHTML = `
      <div style="text-align:center;margin-bottom:16px;">
        <div style="font-size:48px;font-weight:700;color:${color};">${r.total}/100</div>
        <div style="color:var(--text2);">${r.verdict||''}</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="num">${r.market||0}</div><div class="label">–†—ã–Ω–æ–∫</div></div>
        <div class="stat-card"><div class="num">${r.competition||0}</div><div class="label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è</div></div>
        <div class="stat-card"><div class="num">${r.mvp_speed||0}</div><div class="label">–°–∫–æ—Ä–æ—Å—Ç—å MVP</div></div>
        <div class="stat-card"><div class="num">${r.monetization||0}</div><div class="label">–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è</div></div>
        <div class="stat-card"><div class="num">${r.scalability||0}</div><div class="label">–ú–∞—Å—à—Ç–∞–±</div></div>
      </div>
    `;
  }
}

async function searchReddit() {
  const q = document.getElementById('redditInput').value;
  if(!q) return;
  document.getElementById('redditResult').innerHTML = '<p style="color:var(--accent);">‚è≥ –ò—â—É –Ω–∞ Reddit...</p>';
  const r = await api('/api/reddit-search','POST',{query:q});
  if(r?.posts) {
    document.getElementById('redditResult').innerHTML = `
      ${r.posts.slice(0,5).map(p => `
        <div class="reddit-post">
          <div class="post-title">${p.title}</div>
          <div class="post-meta">r/${p.subreddit} | ‚¨ÜÔ∏è ${p.score} | üí¨ ${p.comments}</div>
          ${p.text ? `<div class="post-text">${p.text.slice(0,200)}</div>` : ''}
        </div>
      `).join('')}
      <div class="card" style="margin-top:12px;">
        <h3>üß† AI –ê–Ω–∞–ª–∏–∑ –±–æ–ª–µ–π</h3>
        <div style="white-space:pre-wrap;font-size:14px;line-height:1.6;">${r.analysis||''}</div>
      </div>
    `;
  }
  await loadAll();
}

async function searchTrends() {
  const q = document.getElementById('trendInput').value;
  if(!q) return;
  document.getElementById('trendResult').innerHTML = '<p style="color:var(--accent);">‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç—Ä–µ–Ω–¥—ã...</p>';
  const r = await api('/api/trends','POST',{query:q});
  document.getElementById('trendResult').innerHTML = r?.analysis ?
    `<div style="white-space:pre-wrap;line-height:1.6;font-size:14px;">${r.analysis}</div>` :
    '<p style="color:var(--red);">–û—à–∏–±–∫–∞</p>';
  await loadAll();
}

// === ACHIEVEMENTS ===
function renderAchievements() {
  const unlocked = STATE.achievements.filter(a => a.unlocked);
  const locked = STATE.achievements.filter(a => !a.unlocked);
  return `
    <div class="card">
      <h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (${unlocked.length}/${STATE.achievements.length})</h2>
      <div class="xp-bar" style="margin-bottom:16px;"><div class="xp-bar-fill" style="width:${STATE.achievements.length?unlocked.length/STATE.achievements.length*100:0}%"></div></div>
      <div class="ach-grid">
        ${unlocked.map(a => `<div class="ach-item" title="${a.desc}"><span class="ach-icon">${a.icon}</span><span class="ach-name">${a.name}</span></div>`).join('')}
        ${locked.map(a => `<div class="ach-item locked" title="${a.desc}"><span class="ach-icon">${a.icon}</span><span class="ach-name">${a.name}</span></div>`).join('')}
      </div>
    </div>
  `;
}

// === FUNNEL ===
function renderFunnel() {
  const stages = ['idea','validation','mvp','launch','growth'];
  const names = {idea:'üí° –ò–¥–µ—è',validation:'üîç –í–∞–ª–∏–¥–∞—Ü–∏—è',mvp:'üõ† MVP',launch:'üöÄ –ó–∞–ø—É—Å–∫',growth:'üìà –†–æ—Å—Ç'};
  const active = STATE.projects.filter(p => p.status !== 'archived');

  return `
    <div class="card">
      <h2>üìà –í–æ—Ä–æ–Ω–∫–∞ –≥–∏–ø–æ—Ç–µ–∑</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:16px;">–ü–µ—Ä–µ–º–µ—â–∞–π –ø—Ä–æ–µ–∫—Ç—ã –ø–æ —Å—Ç–∞–¥–∏—è–º –∫–ª–∏–∫–∞—è –Ω–∞ —Å—Ç–∞–¥–∏—é –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ–µ–∫—Ç–∞</p>
    </div>
    ${stages.map(s => {
      const projects = active.filter(p => (p.stage||'idea') === s);
      return `
        <div class="card">
          <h2>${names[s]} <span style="color:var(--text3);font-size:14px;">(${projects.length})</span></h2>
          ${projects.length ? projects.map(p => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:8px;margin-bottom:6px;">
              <div>
                <strong style="cursor:pointer;" onclick="openProject('${p.id}')">${p.name}</strong>
                ${p.revenue > 0 ? `<span style="color:var(--green);margin-left:8px;">$${p.revenue}</span>` : ''}
              </div>
              <div style="display:flex;gap:4px;">
                ${s !== 'idea' ? `<button class="btn btn-sm btn-secondary" onclick="changeStage('${p.id}','${stages[stages.indexOf(s)-1]}')">‚Üê</button>` : ''}
                ${s !== 'growth' ? `<button class="btn btn-sm btn-primary" onclick="changeStage('${p.id}','${stages[stages.indexOf(s)+1]}')">‚Üí</button>` : ''}
              </div>
            </div>
          `).join('') : '<p style="color:var(--text3);font-size:13px;">–ü—É—Å—Ç–æ</p>'}
        </div>
      `;
    }).join('')}
  `;
}

// === SETTINGS ===
function renderSettings() {
  return `
    <div class="card">
      <h2>üíæ –î–∞–Ω–Ω—ã–µ</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:12px;">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a href="/api/export" class="btn btn-primary" download>üì• –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø</a>
        <button class="btn btn-secondary" onclick="showImport()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±—ç–∫–∞–ø</button>
      </div>
    </div>

    <div class="card">
      <h2>üîß –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
      <div style="font-size:13px;color:var(--text2);line-height:2;">
        <div>üìä –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${STATE.stats.total_projects||0}</div>
        <div>üì¶ –í –∞—Ä—Ö–∏–≤–µ: ${STATE.stats.archived_projects||0}</div>
        <div>‚öîÔ∏è –í—Å–µ–≥–æ –∫–≤–µ—Å—Ç–æ–≤: ${STATE.stats.total_quests||0}</div>
        <div>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${STATE.stats.completed_quests||0}</div>
        <div>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: ${STATE.stats.total_messages||0}</div>
        <div>üîç –ù–∏—à –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${STATE.stats.niches_analyzed||0}</div>
        <div>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: ${STATE.stats.achievements_unlocked||0}/${STATE.stats.achievements_total||0}</div>
        <div>üî• Streak —Ä–µ–∫–æ—Ä–¥: ${STATE.player.max_streak||0} –¥–Ω–µ–π</div>
      </div>
    </div>

    <div class="card">
      <h2>‚ù§Ô∏è Health Check</h2>
      <button class="btn btn-secondary" onclick="checkHealth()">üè• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <div id="healthResult" style="margin-top:12px;"></div>
    </div>
  `;
}

function showImport() {
  showModal('–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—ç–∫–∞–ø', `
    <div class="form-group">
      <label>–í—ã–±–µ—Ä–∏ JSON —Ñ–∞–π–ª</label>
      <input type="file" id="importFile" accept=".json" style="padding:8px;">
    </div>
    <p style="color:var(--orange);font-size:12px;">‚ö†Ô∏è –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ!</p>
  `, async () => {
    const file = document.getElementById('importFile').files[0];
    if(!file) return;
    const text = await file.text();
    try {
      const data = JSON.parse(text);
      const r = await api('/api/import','POST',data);
      if(r?.ok) {
        toast('üì§ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!','success');
        closeModal();
        await loadAll();
      }
    } catch(e) {
      toast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞','error');
    }
  });
}

async function checkHealth() {
  const r = await fetch('/health').then(r=>r.json());
  document.getElementById('healthResult').innerHTML = `<pre style="font-size:12px;color:var(--green);background:var(--bg3);padding:12px;border-radius:8px;">${JSON.stringify(r,null,2)}</pre>`;
}

// === MODAL ===
function showModal(title, content, onConfirm) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'modal';
  modal.innerHTML = `
    <div class="modal">
      <h2>${title}</h2>
      ${content}
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        ${onConfirm ? '<button class="btn btn-primary" id="modalConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>' : ''}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.modal-overlay')?.addEventListener('click', e => { if(e.target === modal) closeModal(); });
  if(onConfirm) document.getElementById('modalConfirm').addEventListener('click', onConfirm);
}

function closeModal() {
  document.getElementById('modal')?.remove();
}

// === SIDEBAR TOGGLE ===
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
}

// === INIT ===
loadAll();
</script>
</body>
</html>
